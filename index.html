<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy New Year 2026 - Special for Ngoc Linh</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* Import Font ch·ªØ ƒë·∫πp */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Dancing+Script:wght@700&family=Orbitron:wght@900&family=Great+Vibes&family=Nunito:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0; background-color: #000; overflow: hidden;
            font-family: 'Nunito', sans-serif; height: 100vh; width: 100vw; user-select: none;
        }

        /* --- BACKGROUND LAYERS --- */
        #bg-image-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            transition: opacity 2s ease-in-out; background: #000;
        }
        #bg-image-layer img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        #canvas-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-color: #000;
        }

        /* --- LANDING SCREEN & UI --- */
        #landing-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-family: 'Nunito', sans-serif; font-weight: 700;
            color: #fff; background: linear-gradient(45deg, #ff0055, #ff00aa);
            border: 2px solid #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 30px #ff00aa; transition: transform 0.2s, box-shadow 0.2s;
        }
        #start-btn:hover { transform: scale(1.1); box-shadow: 0 0 50px #ff00aa; }
        
        #loading {
            position: absolute; top: 60%; left: 50%; transform: translateX(-50%);
            font-family: 'Nunito', sans-serif; color: #fff; font-size: 1.2rem; display: none; z-index: 101;
            text-align: center; width: 100%;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            transition: opacity 0.5s;
        }
        
        .fade-out-transition { opacity: 0 !important; transition: opacity 1.5s ease-out; }

        #greeting-box { display: none; margin-bottom: 20px; animation: fadeIn 1s ease-out; transition: opacity 1s; }
        .greet-line1 {
            font-family: 'Dancing Script', cursive; font-size: 3.5rem; color: #fff;
            text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff00aa; margin-bottom: 10px;
        }
        .greet-line2 {
            font-family: 'Cinzel', serif; font-size: 4rem; font-weight: bold; color: #ffd700;
            text-transform: uppercase; text-shadow: 0 0 15px #ffd700, 0 0 30px #ff4500; letter-spacing: 3px;
        }
        
        #countdown-number {
            font-family: 'Orbitron', sans-serif; font-size: 15rem; line-height: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #ffd700 50%, #ff8c00 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 50px rgba(255, 215, 0, 0.8));
            display: none; margin-top: 20px;
            transition: opacity 1s;
        }
        .pop-anim { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        #guide-text {
            position: absolute; bottom: 15%; font-family: 'Nunito', sans-serif; font-weight: 700;
            font-size: 1.5rem; color: rgba(255,255,255,0.9); text-shadow: 0 0 10px #000;
            width: 100%; text-align: center; transition: opacity 1s;
        }

        /* Timer cho ph·∫ßn Finale */
        #finale-timer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; z-index: 150; pointer-events: none;
            font-family: 'Dancing Script', cursive; font-size: 2rem; color: #fff;
            text-shadow: 0 0 10px #ff1493, 0 0 20px #ff00aa;
            display: none; opacity: 0; transition: opacity 1s;
        }

        /* --- FLOATING ITEMS --- */
        #floating-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 40;
            overflow: hidden; pointer-events: none; display: none; 
            transition: opacity 2s ease;
        }
        .float-item { 
            position: absolute; top: 100%; will-change: transform; 
            animation: floatUp 15s linear forwards; 
        }
        @keyframes floatUp { 
            0% { transform: translateY(0); opacity: 0; } 
            5% { opacity: 1; } 90% { opacity: 1; } 
            100% { transform: translateY(-150vh); opacity: 0; } 
        }
        .msg-box {
            z-index: 50; background: rgba(20, 0, 10, 0.85); border: 2px solid #ff69b4;
            border-radius: 20px; padding: 20px 30px; width: 300px; text-align: center;
            color: #fff; font-family: 'Dancing Script', cursive; font-size: 1.8rem;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.8); white-space: pre-wrap;
        }
        .img-box {
            z-index: 45; padding: 8px; background: #ff1493; border-radius: 15px;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.5); width: 250px; min-height: 150px; 
            display: flex; justify-content: center; align-items: center;
        }
        .img-box img { width: 100%; display: block; border-radius: 10px; }
        
        /* --- CAMERA & OVERLAY --- */
        #camera-box {
            position: absolute; bottom: 20px; right: 20px; width: 160px; height: 120px;
            z-index: 90; border: 2px solid #ff00aa; border-radius: 10px; overflow: hidden;
            background: #000; transform: scaleX(-1); display: none; opacity: 0.7;
        }
        .input_video { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
        #camera-overlay { position: absolute; top:0; left:0; width:100%; height:100%; }

        /* --- 3D LETTER STYLES --- */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            display: none; justify-content: center; align-items: center;
            perspective: 1500px; pointer-events: none; 
        }

        .book-wrapper {
            position: relative; width: 750px; height: 500px; 
            transform-style: preserve-3d; transition: transform 1s ease-in-out;
            animation: cardFloatUp 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            pointer-events: auto; flex-shrink: 0;
        }
        @keyframes cardFloatUp { from { transform: translateY(100vh); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        @keyframes glowPulse {
            from { box-shadow: 0 0 20px rgba(255, 20, 147, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 20, 147, 1), 0 0 60px rgba(255, 105, 180, 0.8); }
        }
        
        .book-page {
            position: absolute; top: 0; width: 50%; height: 100%;
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s;
            transform-origin: left center; backface-visibility: hidden;
            box-shadow: 0 0 20px rgba(255, 20, 147, 0.5);
            animation: glowPulse 2s infinite alternate;
        }

        /* B√¨a Tr∆∞·ªõc */
        .cover-front {
            left: 50%; z-index: 20;
            background: url('res/image/love1.png') center/cover no-repeat;
            background-color: #ffb6c1; 
            border-radius: 0 15px 15px 0;
            position: relative;
            transform: rotateY(0deg); 
            border: 8px double #ff69b4; border-left: none; box-sizing: border-box;
        }

        .cover-front::after {
            content: "For My Love"; 
            font-family: 'Great Vibes', cursive; font-size: 4rem; color: #fff; 
            text-shadow: 0 0 10px #ff0000;
            background: rgba(0,0,0,0.4); padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: max-content; max-width: 80%; text-align: center;
        }

        /* Trang Ph·∫£i (N·ªôi dung) */
        .page-right {
            left: 50%; z-index: 10; background: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; box-sizing: border-box; text-align: center;
            font-family: 'Nunito', sans-serif; color: #d63384;
            border: 8px double #ff69b4; border-left: none; border-radius: 0 15px 15px 0;
        }

        /* Trang Tr√°i (·∫¢nh) */
        .page-left {
            left: 0; z-index: 10; background: #fff5ee;
            border-radius: 15px 0 0 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px; box-sizing: border-box;
            border: 8px double #ff69b4; border-right: none;
            opacity: 0; transform: rotateY(0deg); 
        }
        .page-left img {
            width: 85%; height: 42%; object-fit: cover; margin: 10px 0;
            border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: rotate(-3deg);
        }
        .page-left img:last-child { transform: rotate(3deg); }

        /* Tr·∫°ng th√°i M·ªü */
        .book-wrapper.open .cover-front { transform: rotateY(-180deg); opacity: 0; pointer-events: none; }
        .book-wrapper.open .page-left { opacity: 1; transition-delay: 0.2s; }
        
        .text-content {
            font-size: 1.4rem; line-height: 1.6; font-weight: 600;
            margin-bottom: 25px; min-height: 180px; width: 90%;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 1px rgba(214, 51, 132, 0.1);
        }
        
        .ctrl-btn {
            margin-top: 15px; padding: 10px 25px; border: none; background: #ff1493; color: white;
            font-family: 'Nunito', sans-serif; font-weight: bold; border-radius: 25px; cursor: pointer;
            box-shadow: 0 3px 10px rgba(255,20,147,0.4); transition: 0.2s; font-size: 1.1rem;
            position: relative; z-index: 100;
        }
        .ctrl-btn:hover { background: #ff007f; transform: scale(1.05); }
        .reset-btn { background: #444; margin-top: 15px; font-size: 1rem; }
        .reset-btn:hover { background: #666; }

        #letter-controls {
            position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; opacity: 0; transition: opacity 0.5s; 
            pointer-events: auto; z-index: 210;
        }
        #btn-open-letter {
             padding: 18px 50px; font-size: 1.8rem; background: #ff0055; color: white; border: none; border-radius: 50px;
             box-shadow: 0 0 25px #ff0055; cursor: pointer; animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- HI·ªÜU ·ª®NG TIM BAY T·ª™ TH∆Ø (NEW CODE) --- */
        .floating-heart {
            position: absolute;
            font-size: 1.5rem;
            user-select: none;
            pointer-events: none;
            z-index: 300; /* Cao h∆°n s√°ch ƒë·ªÉ n·ªïi l√™n tr√™n */
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            animation: floatHeartAnim 2.5s ease-out forwards;
        }
        
        @keyframes floatHeartAnim {
            0% { 
                transform: translate(-50%, 0) scale(0.5) rotate(0deg); 
                opacity: 0; 
            }
            10% { opacity: 1; }
            50% { transform: translate(calc(-50% + 20px), -100px) scale(1.2) rotate(20deg); }
            100% { 
                transform: translate(calc(-50% - 20px), -250px) scale(1) rotate(-20deg); 
                opacity: 0; 
            }
        }
    </style>
</head>
<body>

    <div id="landing-screen">
        <button id="start-btn">Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c</button>
    </div>
    <div id="loading">ƒêang t·∫£i h·ªá th·ªëng...</div>

    <div id="bg-image-layer">
        <img src="res/image/back.png" alt="Background" onerror="this.style.display='none'">
    </div>
    <canvas id="canvas-bg"></canvas>

    <div id="camera-box">
        <video class="input_video" playsinline></video>
        <canvas id="camera-overlay"></canvas>
    </div>

    <div id="ui-layer">
        <div id="greeting-box">
            <div class="greet-line1">Ch√∫c m·ª´ng nƒÉm m·ªõi nh√©</div>
            <div class="greet-line2">Ng·ªçc Linh !</div>
        </div>

        <div id="countdown-number">5</div>
        
        <div id="guide-text"></div>
        
        <div id="finale-timer"></div>
    </div>

    <div id="floating-container"></div>

    <div id="letter-container">
        <div class="book-wrapper" id="the-book">
            <div class="book-page cover-front"></div>
            <div class="book-page page-left">
                <img src="res/image/love1.png" alt="Love 1">
                <img src="res/image/love2.jpg" alt="Love 2">
            </div>
            <div class="book-page page-right">
                <div class="text-content" id="letter-text">Loading message...</div>
                <button class="ctrl-btn" id="btn-next-msg">ƒê·ªçc ti·∫øp ‚ù§Ô∏è</button>
                <button class="ctrl-btn" id="btn-close-letter" style="display:none;">ƒê√≥ng thi·ªáp</button>
            </div>
        </div>
        
        <div id="letter-controls">
            <button id="btn-open-letter">M·ªü Thi·ªáp üíå</button>
            <button class="ctrl-btn reset-btn" id="btn-reset-game" style="display:none;">L√†m l·∫°i t·ª´ ƒë·∫ßu ‚Üª</button>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const FINALE_DURATION = 10000; // ms (Th·ªùi gian tr√¥i ·∫£nh/nh·∫°c)

        // --- √ÇM THANH SYSTEM ---
        const AUDIO = {
            bgIntro: new Audio('res/sound/bg_intro.mp3'),
            bgFinale: new Audio('res/sound/bg_finale.mp3'),
            bgLetter: new Audio('res/sound/bg_letter.mp3'),
            count5: new Audio('res/sound/count_5.mp3'),
            count4: new Audio('res/sound/count_4.mp3'),
            count3: new Audio('res/sound/count_3.mp3'),
            count2: new Audio('res/sound/count_2.mp3'),
            count1: new Audio('res/sound/count_1.mp3'),
            whistle: new Audio('res/sound/whistle.mp3'),
            boom: new Audio('res/sound/boom.mp3')
        };

        AUDIO.bgIntro.loop = true; AUDIO.bgIntro.volume = 0.4;
        AUDIO.bgFinale.loop = true; AUDIO.bgFinale.volume = 0.8;
        AUDIO.bgLetter.loop = true; AUDIO.bgLetter.volume = 0.7;
        
        AUDIO.count5.volume = 1.0; AUDIO.count4.volume = 1.0;
        AUDIO.count3.volume = 1.0; AUDIO.count2.volume = 1.0;
        AUDIO.count1.volume = 1.0; AUDIO.whistle.volume = 1.0; AUDIO.boom.volume = 1.0;

        function playCountSound(num) {
            [AUDIO.count5, AUDIO.count4, AUDIO.count3, AUDIO.count2, AUDIO.count1].forEach(a => {
                a.pause(); a.currentTime = 0;
            });
            if(num === 5) AUDIO.count5.play();
            if(num === 4) AUDIO.count4.play();
            if(num === 3) AUDIO.count3.play();
            if(num === 2) AUDIO.count2.play();
            if(num === 1) AUDIO.count1.play();
        }

        function fadeOutAudio(audio, duration = 1500) {
            if (audio.paused) return;
            const originalVolume = audio.volume;
            const stepTime = 50;
            const step = originalVolume / (duration / stepTime);
            
            const fadeInterval = setInterval(() => {
                if (audio.volume > step) {
                    audio.volume -= step;
                } else {
                    audio.volume = 0;
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = originalVolume; 
                    clearInterval(fadeInterval);
                }
            }, stepTime);
        }

        // --- D·ªÆ LI·ªÜU ---
        const MESSAGES = [
            "üå∏ Happy New Year 2026 Ng·ªçc Linh! üå∏", "Ch√∫c b·∫°n y√™u m·ªôt nƒÉm r·ª±c r·ª° s·∫Øc m√†u! ‚ú®",
            "M√£i xinh ƒë·∫πp, r·∫°ng ng·ªùi nh∆∞ th·∫ø nh√©! üíÉ", "C·∫£m ∆°n v√¨ ƒë√£ ·ªü b√™n t√¥i! ‚ù§Ô∏è",
            "NƒÉm m·ªõi th·∫Øng l·ª£i m·ªõi nh√© b·∫°n t√¥i ∆°i! üèÜ", "Lu√¥n m·ªâm c∆∞·ªùi th·∫≠t t∆∞∆°i nh√©! üòä",
            "Y√™u Linh nhi·ªÅu th·∫≠t nhi·ªÅu! üíñ", "Ch√∫c Linh v·∫°n s·ª± nh∆∞ √Ω - T·ª∑ s·ª± nh∆∞ m∆° üåü",
            "S·ª©c kh·ªèe d·ªìi d√†o, b√¨nh an h·∫°nh ph√∫c üçÄ", "NƒÉm 2026 th·∫≠t b√πng n·ªï v√† th√†nh c√¥ng! üéÜ",
            "M√£i l√† c√¥ g√°i tuy·ªát v·ªùi nh·∫•t qu·∫£ ƒë·∫•t! üëë", "Ti·ªÅn v√†o nh∆∞ n∆∞·ªõc, ƒë·∫øm m·ªèi tay lu√¥n üí∞",
            "T√¨nh duy√™n ph∆°i ph·ªõi, h·∫°nh ph√∫c ng·∫≠p tr√†n üíï", "Lu√¥n t·ªèa s√°ng nh∆∞ m·ªôt v√¨ sao nh√© ‚≠êÔ∏è",
            "Ch√∫c m·ª´ng nƒÉm m·ªõi ng∆∞·ªùi th∆∞∆°ng! ü•Ç", "Mong m·ªçi ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t ƒë·∫øn v·ªõi Linh üå∏",
            "C√πng nhau ƒë√≥n th√™m nhi·ªÅu c√°i T·∫øt n·ªØa nh√©! ü§ù", "NƒÉm m·ªõi b·ªõt lo √¢u, th√™m ni·ªÅm vui üòÑ",
            "Ch√∫c Linh ƒëi ƒë√¢u c≈©ng g·∫∑p may m·∫Øn üçÄ", "S·ª± nghi·ªáp thƒÉng ti·∫øn v√π v√π nh∆∞ di·ªÅu g·∫∑p gi√≥ üöÄ",
            "Happy New Year my love! üíã", "Ch√∫c Linh ƒÉn nhi·ªÅu m√≥n ngon m√† kh√¥ng b√©o üçï",
            "Lu√¥n gi·ªØ v·ªØng ƒëam m√™ ch√°y b·ªèng nh√©! üî•", "NƒÉm m·ªõi r·∫°ng r·ª° nh∆∞ √°nh m·∫∑t tr·ªùi ‚òÄÔ∏è",
            "Ch√∫c Linh ƒë·∫°t ƒë∆∞·ª£c m·ªçi ∆∞·ªõc m∆° üåà", "Lu√¥n b√¨nh y√™n v√† ·∫•m √°p b√™n gia ƒë√¨nh üè†",
            "M·ªôt nƒÉm 2026 th·∫≠t ƒë√°ng nh·ªõ nh√©! üì∏", "G·ª≠i ng√†n n·ª• h√¥n n·ªìng th·∫Øm ƒë·∫øn Linh üòò",
            "Ch√∫c Linh m·ªói ng√†y ƒë·ªÅu l√† m·ªôt ng√†y vui üòÅ", "M√£i b√™n nhau b·∫°n nh√©! üíû",
            "Ch√∫c Linh xinh ƒë·∫πp b·∫•t ch·∫•p th·ªùi gian üåπ", "Ch√∫c m·ª´ng nƒÉm m·ªõi 2026 r·ª±c r·ª°!!! üéâ"
        ];

        // M·∫£ng ·∫£nh t·ªïng h·ª£p (ƒë·ªÉ preload)
        const IMAGES = [
            "res/image/love1.png", "res/image/love2.jpg",
            "res/image/IMG_5966.JPG", "res/image/IMG_5977.JPG", "res/image/IMG_5940.JPG", "res/image/IMG_5970.JPG",
            "res/image/IMG_5942.JPG", "res/image/IMG_5968.JPG", "res/image/IMG_5971.JPG", "res/image/IMG_5943.JPG",
            "res/image/IMG_5969.JPG", "res/image/IMG_5939.JPG", "res/image/IMG_5938.JPG", "res/image/IMG_5974.JPG",
            "res/image/IMG_5976.JPG", "res/image/IMG_5973.JPG", "res/image/IMG_5941.JPG", "res/image/IMG_5960.JPG",
            "res/image/IMG_5975.JPG", "res/image/IMG_5946.JPG", "res/image/IMG_5948.JPG", "res/image/IMG_5949.JPG",
            "res/image/IMG_5947.JPG", "res/image/IMG_5957.JPG", "res/image/IMG_5956.JPG", "res/image/IMG_5944.JPG",
            "res/image/IMG_5945.JPG", "res/image/IMG_5861.JPG", "res/image/IMG_5862.JPG", "res/image/IMG_5852.JPG",
            "res/image/IMG_5851.JPG", "res/image/IMG_5951.JPG", "res/image/IMG_5954.JPG", "res/image/IMG_5952.JPG"
        ];
        
        // L·ªçc ·∫£nh tr√¥i (Kh√¥ng bao g·ªìm ·∫£nh thi·ªáp love1, love2)
        const FLOATING_IMAGES = IMAGES.filter(img => !img.includes('love1') && !img.includes('love2'));

        // N·ªôi dung th∆∞
        const LETTER_MESSAGES = [
            "G·ª≠i Ng·ªçc Linh,\nNƒÉm m·ªõi ƒë√£ ƒë·∫øn r·ªìi, anh mu·ªën g·ª≠i ƒë·∫øn em nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t. C·∫£m ∆°n em v√¨ ƒë√£ xu·∫•t hi·ªán v√† l√†m cu·ªôc s·ªëng c·ªßa anh tr·ªü n√™n r·ª±c r·ª° h∆°n bao gi·ªù h·∫øt. üåπ",
            "NƒÉm 2026 n√†y, anh mong em s·∫Ω lu√¥n c∆∞·ªùi th·∫≠t t∆∞∆°i, ƒë·∫°t ƒë∆∞·ª£c m·ªçi ∆∞·ªõc m∆° m√† em ·∫•p ·ªß. D√π c√≥ chuy·ªán g√¨ x·∫£y ra, h√£y nh·ªõ r·∫±ng lu√¥n c√≥ anh ·ªü ph√≠a sau ·ªßng h·ªô em h·∫øt m√¨nh. üí™‚ù§Ô∏è",
            "Y√™u em r·∫•t nhi·ªÅu! Ch√∫c m·ª´ng nƒÉm m·ªõi, c√¥ g√°i tuy·ªát v·ªùi nh·∫•t c·ªßa anh. H√£y c√πng nhau t·∫°o n√™n th·∫≠t nhi·ªÅu k·ª∑ ni·ªám ƒë·∫πp n·ªØa nh√©! üíë‚ú®"
        ];

        // --- GLOBAL VARIABLES & SELECTORS ---
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const overlayCanvas = document.getElementById('camera-overlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        const videoElement = document.getElementsByClassName('input_video')[0];
        const landingScreen = document.getElementById('landing-screen');
        const startBtn = document.getElementById('start-btn');
        const loadingText = document.getElementById('loading');
        const bgLayer = document.getElementById('bg-image-layer');
        const cameraBox = document.getElementById('camera-box');
        const uiLayer = document.getElementById('ui-layer');
        const countDisplay = document.getElementById('countdown-number');
        const greetingBox = document.getElementById('greeting-box');
        const guideText = document.getElementById('guide-text');
        const floatContainer = document.getElementById('floating-container');
        const finaleTimer = document.getElementById('finale-timer'); 

        // Element thi·ªáp
        const letterContainer = document.getElementById('letter-container');
        const theBook = document.getElementById('the-book');
        const letterControls = document.getElementById('letter-controls');
        const btnOpenLetter = document.getElementById('btn-open-letter');
        const btnNextMsg = document.getElementById('btn-next-msg');
        const btnCloseLetter = document.getElementById('btn-close-letter');
        const btnResetGame = document.getElementById('btn-reset-game');
        const letterText = document.getElementById('letter-text');

        let appState = 'LANDING'; 
        let targetNumber = 5; 
        let fireworks = [];
        let stars = [];
        let floatInterval;
        let finaleTimerInterval; // Interval cho timer
        let floatIndex = 0;
        let finaleOngoing = false;
        let isResetting = false;
        
        let screenFlash = 0; 
        let flashColor = '255, 105, 180';
        let currentLetterPage = 0;

        // --- INIT & RESIZE ---
        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            overlayCanvas.width = 160; overlayCanvas.height = 120;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CLASS HI·ªÜU ·ª®NG ---
        class Star {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2; this.alpha = Math.random(); this.blink = Math.random() * 0.02;
            }
            draw() { ctx.fillStyle = `rgba(255,255,255,${this.alpha})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
            update() { this.alpha += this.blink; if(this.alpha <= 0 || this.alpha >= 1) this.blink *= -1; }
        }
        for(let i=0; i<150; i++) stars.push(new Star());

        class Firework {
            constructor(startX, startY, targetY, type = 'normal') {
                this.x = startX; this.y = startY; this.targetY = targetY; this.type = type;
                if (type === 'big-opener') { this.speed = 4.5; } else { this.speed = Math.random() * 4 + 10; }
                this.particles = []; this.exploded = false;
                if(type === 'big-opener') {
                    this.hue = 340; 
                    AUDIO.whistle.currentTime = 0; AUDIO.whistle.play().catch(e => console.log(e));
                } else if (type === 'finale-round') {
                    this.hue = Math.random() * 360; 
                } else { this.hue = Math.random() * 360; }
            }
            update() {
                if(!this.exploded) {
                    this.y -= this.speed; 
                    if (this.type === 'big-opener') { this.speed *= 0.998; } else { this.speed *= 0.95; }
                    if(this.type === 'big-opener') { ctx.fillStyle = 'rgba(255,100,150,0.8)'; ctx.beginPath(); ctx.arc(this.x, this.y + 10, 3, 0, Math.PI*2); ctx.fill(); }
                    if(this.y <= this.targetY || this.speed <= 1) this.explode();
                } else {
                    this.particles.forEach((p,i) => { p.update(); if(p.alpha <= 0) this.particles.splice(i,1); });
                }
            }
            explode() {
                this.exploded = true;
                if(this.type === 'finale-round' || this.type === 'big-opener') {
                    screenFlash = 5;
                    const flashColors = [ '255, 20, 147', '255, 0, 0', '148, 0, 211', '255, 105, 180' ];
                    flashColor = flashColors[Math.floor(Math.random() * flashColors.length)];
                }
                if (this.type === 'big-opener') {
                    AUDIO.boom.currentTime = 0; AUDIO.boom.play().catch(e => console.log(e));
                    const particleCount = 600;
                    for(let i=0; i < particleCount; i++) {
                        const t = (Math.PI * 2 * i) / particleCount;
                        const dx = 16 * Math.pow(Math.sin(t), 3);
                        const dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                        const hue = 320 + Math.random() * 40; 
                        const p = new Particle(this.x, this.y, hue, 0); 
                        const scale = 0.9 + Math.random() * 0.2; 
                        p.vx = dx * scale; p.vy = (dy - 5) * scale;
                        p.gravity = 0.05; p.friction = 0.96; p.decay = 0.005; p.sparkle = true;  
                        this.particles.push(p);
                    }
                } else {
                    let count = (this.type === 'finale-round') ? 300 : 40; 
                    let spread = (this.type === 'finale-round') ? 15 : 5;
                    for(let i=0; i<count; i++) this.particles.push(new Particle(this.x, this.y, this.hue, spread));
                }
            }
            draw() {
                if(!this.exploded) { ctx.fillStyle = (this.type === 'big-opener') ? '#fff' : `hsl(${this.hue}, 100%, 60%)`; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); }
                else { this.particles.forEach(p => p.draw()); }
            }
        }

        class Particle {
            constructor(x, y, hue, spreadSpeed) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2; const speed = Math.random() * spreadSpeed + 1; 
                this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                this.alpha = 1; this.friction = 0.96; this.gravity = 0.04;
                this.decay = Math.random() * 0.008 + 0.004; this.hue = hue; this.sparkle = Math.random() < 0.5; 
            }
            update() {
                this.vx *= this.friction; this.vy *= this.friction;
                this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.alpha -= this.decay;
            }
            draw() {
                ctx.save(); ctx.globalCompositeOperation = 'lighter';
                let currentAlpha = this.alpha; if(this.sparkle) currentAlpha *= (0.5 + Math.random() * 0.5); 
                ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${currentAlpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        function animateCanvas() {
            if (screenFlash > 0) {
                ctx.fillStyle = `rgba(${flashColor}, ${screenFlash * 0.015})`; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                screenFlash--;
            } else {
                ctx.fillStyle = 'rgba(0,0,0,0.2)'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            if(appState !== 'LANDING') stars.forEach(s => { s.update(); s.draw(); });
            if(appState === 'COUNTDOWN' && Math.random() < 0.05) {
                fireworks.push(new Firework(Math.random() * canvas.width, canvas.height, Math.random() * (canvas.height * 0.5), 'normal'));
            }
            
            if(finaleOngoing && Math.random() < 0.08) { 
                fireworks.push(new Firework(
                    Math.random() * canvas.width, 
                    canvas.height, 
                    canvas.height * 0.05 + Math.random() * (canvas.height * 0.5), 
                    'finale-round'
                ));
            }

            fireworks.forEach((fw, i) => {
                fw.update(); fw.draw(); if(fw.exploded && fw.particles.length === 0) fireworks.splice(i,1);
            });
            requestAnimationFrame(animateCanvas);
        }
        animateCanvas();

        // --- PRELOAD LOGIC ---
        let imagesLoaded = 0;
        const totalImages = IMAGES.length;

        function preloadAllImages() {
            return new Promise((resolve) => {
                if (totalImages === 0) resolve();
                IMAGES.forEach((src) => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        imagesLoaded++;
                        loadingText.innerText = `ƒêang t·∫£i t√†i nguy√™n... ${Math.floor((imagesLoaded / totalImages) * 100)}%`;
                        if (imagesLoaded === totalImages) resolve();
                    };
                    img.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) resolve(); };
                });
            });
        }

        // --- GAME START LOGIC ---
        startBtn.addEventListener('click', async () => {
            AUDIO.bgIntro.play().catch(e => console.log("C·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng ƒë·ªÉ ph√°t nh·∫°c"));
            landingScreen.style.opacity = 0; 
            setTimeout(() => landingScreen.style.display = 'none', 500);
            
            loadingText.style.display = 'block';
            loadingText.innerText = "ƒêang kh·ªüi ƒë·ªông Camera & T·∫£i ·∫£nh...";

            await Promise.all([initCamera(), preloadAllImages()]);
            
            loadingText.style.display = 'none'; 
            cameraBox.style.display = 'block';
            appState = 'WAITING'; 
            guideText.innerText = "Gi∆° 5 ng√≥n tay ƒë·ªÉ b·∫Øt ƒë·∫ßu...";
        });

        async function initCamera() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
            hands.onResults(onResults);
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480
            });
            await camera.start();
        }

        function countFingers(landmarks) {
            let count = 0;
            if (landmarks[8].y < landmarks[6].y) count++;
            if (landmarks[12].y < landmarks[10].y) count++;
            if (landmarks[16].y < landmarks[14].y) count++;
            if (landmarks[20].y < landmarks[18].y) count++;
            const isRight = landmarks[17].x > landmarks[5].x;
            if ((isRight && landmarks[4].x < landmarks[3].x) || (!isRight && landmarks[4].x > landmarks[3].x)) count++;
            return count;
        }

        function onResults(results) {
            overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                drawConnectors(overlayCtx, lm, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 2});
                drawLandmarks(overlayCtx, lm, {color: '#ff0000', lineWidth: 1});
                const fingers = countFingers(lm);
                processGameLogic(fingers);
            } else {
                if(appState === 'COUNTDOWN') {
                    if (!isResetting) resetGame();
                }
            }
        }

        function processGameLogic(fingers) {
            if (isResetting) return; 
            if (appState === 'WAITING') {
                if(fingers === 5) startCountdown();
            } 
            else if (appState === 'COUNTDOWN') {
                if(fingers === targetNumber - 1) {
                    targetNumber = fingers;
                    if(targetNumber > 0) {
                        updateCountdownDisplay(targetNumber);
                    } else {
                        startFinaleSequence();
                    }
                }
            }
        }

        function startCountdown() {
            appState = 'COUNTDOWN'; targetNumber = 5;
            bgLayer.style.opacity = 0;
            guideText.style.bottom = '10%'; guideText.innerText = "Gi·ªØ tay v√† ƒë·∫øm ng∆∞·ª£c d·∫ßn xu·ªëng...";
            greetingBox.style.display = 'block'; countDisplay.style.display = 'block';
            updateCountdownDisplay(5);
        }

        function updateCountdownDisplay(num) {
            countDisplay.innerText = num;
            countDisplay.classList.remove('pop-anim'); void countDisplay.offsetWidth; countDisplay.classList.add('pop-anim');
            playCountSound(num);
        }

        // --- FINALE SEQUENCE ---
        function startFinaleSequence() {
            if(appState === 'FINALE') return;
            appState = 'FINALE';
            
            fadeOutAudio(AUDIO.bgIntro);
            
            greetingBox.classList.add('fade-out-transition');
            countDisplay.classList.add('fade-out-transition');
            guideText.classList.add('fade-out-transition');

            setTimeout(() => {
                greetingBox.style.display = 'none';
                countDisplay.style.display = 'none';
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.innerText = "H√£y t·∫≠n h∆∞·ªüng kho·∫£nh kh·∫Øc n√†y..."; 
                setTimeout(() => guideText.style.opacity = 0, 5000);
            }, 1500);

            fireworks = []; 

            setTimeout(() => {
                fireworks.push(new Firework(canvas.width / 2, canvas.height, canvas.height * 0.35, 'big-opener'));
                setTimeout(() => {
                    AUDIO.bgFinale.play().catch(e => console.log(e));
                    
                    floatContainer.style.display = 'block';
                    floatContainer.style.opacity = '1';
                    
                    spawnFloatingItem(); 
                    if(floatInterval) clearInterval(floatInterval);
                    floatInterval = setInterval(spawnFloatingItem, 2500);
                    finaleOngoing = true; 

                    // --- TIMER ƒê·∫æM NG∆Ø·ª¢C FINALE ---
                    let remainingSeconds = Math.floor(FINALE_DURATION / 1000);
                    finaleTimer.style.display = 'block';
                    finaleTimer.style.opacity = 1;
                    finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: ${remainingSeconds}s`;

                    if(finaleTimerInterval) clearInterval(finaleTimerInterval);
                    finaleTimerInterval = setInterval(() => {
                        remainingSeconds--;
                        if(remainingSeconds > 0) {
                            finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: ${remainingSeconds}s`;
                        } else {
                            finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: 0s`;
                            clearInterval(finaleTimerInterval);
                        }
                    }, 1000);

                    // H·∫πn gi·ªù k·∫øt th√∫c
                    setTimeout(endFinaleAndStartLetter, FINALE_DURATION);

                }, 4000); 
            }, 2000); 
        }

        function endFinaleAndStartLetter() {
            finaleOngoing = false; 
            if(floatInterval) clearInterval(floatInterval); 
            if(finaleTimerInterval) clearInterval(finaleTimerInterval); 
            
            // ·∫®n Timer
            finaleTimer.style.opacity = 0;
            setTimeout(() => finaleTimer.style.display = 'none', 1000);

            fadeOutAudio(AUDIO.bgFinale, 3000);
            
            floatContainer.style.opacity = '0';
            setTimeout(() => {
                floatContainer.innerHTML = ''; 
                floatContainer.style.display = 'none';
            }, 3000);

            setTimeout(() => {
                showLetterSequence();
            }, 5000); 
        }

        // --- LETTER LOGIC ---
        function showLetterSequence() {
            appState = 'LETTER';
            letterContainer.style.display = 'flex'; 
            letterControls.style.opacity = 1;
            
            // Reset tr·∫°ng th√°i s√°ch
            theBook.classList.remove('open');
            currentLetterPage = 0;
            
            btnOpenLetter.style.display = 'block';
            btnOpenLetter.innerText = "M·ªü Thi·ªáp üíå"; 
            btnResetGame.style.display = 'none';
        }

        // --- H√ÄM T·∫†O HI·ªÜU ·ª®NG TIM BAY (NEW CODE) ---
        function spawnLetterHearts() {
            const heartCount = 40; 
            
            for (let i = 0; i < heartCount; i++) {
                setTimeout(() => {
                    const heart = document.createElement('div');
                    heart.classList.add('floating-heart');
                    
                    // Random m√†u: H·ªìng ƒë·∫≠m, ƒê·ªè, H·ªìng nh·∫°t
                    const colors = ['#ff1493', '#ff0000', '#ff69b4'];
                    heart.style.color = colors[Math.floor(Math.random() * colors.length)];
                    
                    heart.innerText = '‚ù§'; 
                    
                    // Random v·ªã tr√≠ X xung quanh t√¢m m√†n h√¨nh
                    const randomOffset = (Math.random() - 0.5) * 250; 
                    heart.style.left = `calc(50% + ${randomOffset}px)`;
                    
                    // V·ªã tr√≠ Y: D∆∞·ªõi t√¢m m√†n h√¨nh m·ªôt ch√∫t
                    heart.style.top = '65%'; 
                    
                    // Random k√≠ch th∆∞·ªõc
                    const size = 1 + Math.random() * 1.5;
                    heart.style.fontSize = `${size}rem`;

                    document.body.appendChild(heart);

                    // X√≥a element sau khi animation k·∫øt th√∫c
                    setTimeout(() => {
                        if (heart.parentNode) heart.remove();
                    }, 2500);
                }, i * 60); 
            }
        }

        btnOpenLetter.addEventListener('click', () => {
            btnOpenLetter.style.display = 'none'; 
            theBook.classList.add('open'); 
            
            // --- G·ªåI HI·ªÜU ·ª®NG TIM BAY (NEW CODE) ---
            spawnLetterHearts(); 
            // ----------------------------------------
            
            // Ch·ªâ b·∫≠t nh·∫°c n·∫øu ƒëang t·∫Øt
            if(AUDIO.bgLetter.paused) {
                AUDIO.bgLetter.play().catch(e=>console.log(e));
            }
            
            currentLetterPage = 0;
            letterText.innerText = LETTER_MESSAGES[0];
            btnNextMsg.style.display = 'inline-block';
            btnCloseLetter.style.display = 'none';
        });

        btnNextMsg.addEventListener('click', () => {
            currentLetterPage++;
            letterText.style.opacity = 0;
            setTimeout(() => {
                if (currentLetterPage < LETTER_MESSAGES.length) {
                    letterText.innerText = LETTER_MESSAGES[currentLetterPage];
                    letterText.style.opacity = 1;
                }
                
                if (currentLetterPage >= 2) { 
                    btnNextMsg.style.display = 'none';
                    btnCloseLetter.style.display = 'inline-block';
                }
            }, 300);
        });

        btnCloseLetter.addEventListener('click', () => {
            theBook.classList.remove('open'); 
            setTimeout(() => {
                btnOpenLetter.style.display = 'block';
                btnOpenLetter.innerText = "M·ªü l·∫°i üíå";
                btnResetGame.style.display = 'block'; 
            }, 1000); 
        });

        btnResetGame.addEventListener('click', () => {
            fadeOutAudio(AUDIO.bgLetter, 1000);
            resetGame();
        });

        function resetGame() {
            if (isResetting) return;
            isResetting = true; 
            
            letterContainer.style.display = 'none';
            letterControls.style.opacity = 0;
            floatContainer.style.opacity = '0';
            
            finaleTimer.style.opacity = 0;
            finaleTimer.style.display = 'none';
            if(finaleTimerInterval) clearInterval(finaleTimerInterval);

            if(!AUDIO.bgFinale.paused) fadeOutAudio(AUDIO.bgFinale, 500);

            setTimeout(() => {
                appState = 'WAITING';
                targetNumber = 5;
                finaleOngoing = false;
                
                if(floatInterval) clearInterval(floatInterval);
                floatContainer.innerHTML = '';
                floatContainer.style.display = 'none';
                fireworks = [];
                
                bgLayer.style.opacity = 1;
                
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.style.opacity = 1; 
                
                greetingBox.style.display = 'none'; 
                countDisplay.style.display = 'none';
                guideText.innerText = "Gi∆° 5 ng√≥n tay ƒë·ªÉ b·∫Øt ƒë·∫ßu...";
                guideText.style.bottom = '15%';

                AUDIO.bgIntro.currentTime = 0;
                AUDIO.bgIntro.volume = 0.4; 
                AUDIO.bgIntro.play().catch(e => console.log("User interaction needed"));

                isResetting = false; 
            }, 1000);
        }

        function spawnFloatingItem() {
            if(appState !== 'FINALE') return;

            const layoutType = Math.random() > 0.5 ? 0 : 1; 
            const msgEl = document.createElement('div'); msgEl.classList.add('float-item', 'msg-box');
            msgEl.innerText = MESSAGES[floatIndex % MESSAGES.length];
            const imgEl = document.createElement('div'); imgEl.classList.add('float-item', 'img-box');
            const img = document.createElement('img');
            
            // Ch·ªçn ·∫£nh ng·∫´u nhi√™n t·ª´ danh s√°ch ƒë√£ l·ªçc (FLOATING_IMAGES)
            const randomImgIndex = Math.floor(Math.random() * FLOATING_IMAGES.length);
            img.src = FLOATING_IMAGES[randomImgIndex]; 
            
            imgEl.appendChild(img);
            
            const randomLeft = 5 + Math.random() * 35; 
            const randomRight = 55 + Math.random() * 35;
            
            if (layoutType === 0) { msgEl.style.left = randomLeft + '%'; imgEl.style.left = randomRight + '%'; } 
            else { msgEl.style.left = randomRight + '%'; imgEl.style.left = randomLeft + '%'; }
            
            floatContainer.appendChild(msgEl); floatContainer.appendChild(imgEl);
            floatIndex++;
            
            setTimeout(() => { if(msgEl.parentNode) msgEl.remove(); }, 15000);
            setTimeout(() => { if(imgEl.parentNode) imgEl.remove(); }, 15000);
        }
    </script>
</body>
</html>