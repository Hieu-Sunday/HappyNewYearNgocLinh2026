<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy New Year 2026 - Special for Ngoc Linh</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* Import Font chá»¯ Ä‘áº¹p */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Dancing+Script:wght@700&family=Orbitron:wght@900&family=Great+Vibes&family=Nunito:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0; background-color: #000; overflow: hidden;
            font-family: 'Nunito', sans-serif; height: 100vh; width: 100vw; user-select: none;
            /* NgÄƒn kÃ©o trang trÃªn mobile */
            overscroll-behavior: none; 
        }

        /* --- BACKGROUND LAYERS --- */
        #bg-image-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            transition: opacity 2s ease-in-out; background: #000;
        }
        #bg-image-layer img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        #canvas-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-color: #000;
        }

        /* --- LANDING SCREEN & UI --- */
        #landing-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-family: 'Nunito', sans-serif; font-weight: 700;
            color: #fff; background: linear-gradient(45deg, #ff0055, #ff00aa);
            border: 2px solid #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 30px #ff00aa; transition: transform 0.2s, box-shadow 0.2s;
            text-align: center; max-width: 90%;
        }
        #start-btn:hover { transform: scale(1.1); box-shadow: 0 0 50px #ff00aa; }
        
        #loading {
            position: absolute; top: 60%; left: 50%; transform: translateX(-50%);
            font-family: 'Nunito', sans-serif; color: #fff; font-size: 1.2rem; display: none; z-index: 101;
            text-align: center; width: 100%;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            transition: opacity 0.5s;
        }
        
        .fade-out-transition { opacity: 0 !important; transition: opacity 1.5s ease-out; }

        #greeting-box { display: none; margin-bottom: 20px; animation: fadeIn 1s ease-out; transition: opacity 1s; }
        .greet-line1 {
            font-family: 'Dancing Script', cursive; font-size: 3.5rem; color: #fff;
            text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff00aa; margin-bottom: 10px;
        }
        .greet-line2 {
            font-family: 'Cinzel', serif; font-size: 4rem; font-weight: bold; color: #ffd700;
            text-transform: uppercase; text-shadow: 0 0 15px #ffd700, 0 0 30px #ff4500; letter-spacing: 3px;
        }
        
        #countdown-number {
            font-family: 'Orbitron', sans-serif; font-size: 15rem; line-height: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #ffd700 50%, #ff8c00 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 50px rgba(255, 215, 0, 0.8));
            display: none; margin-top: 20px;
            transition: opacity 1s;
        }
        .pop-anim { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        #guide-text {
            position: absolute; bottom: 15%; font-family: 'Nunito', sans-serif; font-weight: 700;
            font-size: 1.5rem; color: rgba(255,255,255,0.9); text-shadow: 0 0 10px #000;
            width: 100%; text-align: center; transition: opacity 1s; padding: 0 10px;
        }

        /* Timer cho pháº§n Finale */
        #finale-timer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; z-index: 150; pointer-events: none;
            font-family: 'Dancing Script', cursive; font-size: 2rem; color: #fff;
            text-shadow: 0 0 10px #ff1493, 0 0 20px #ff00aa;
            display: none; opacity: 0; transition: opacity 1s;
        }

        /* --- FLOATING ITEMS --- */
        #floating-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 40;
            overflow: hidden; pointer-events: none; display: none; 
            transition: opacity 2s ease;
        }
        .float-item { 
            position: absolute; top: 100%; will-change: transform; 
            animation: floatUp 15s linear forwards; 
        }
        @keyframes floatUp { 
            0% { transform: translateY(0); opacity: 0; } 
            5% { opacity: 1; } 90% { opacity: 1; } 
            100% { transform: translateY(-150vh); opacity: 0; } 
        }
        .msg-box {
            z-index: 50; background: rgba(20, 0, 10, 0.85); border: 2px solid #ff69b4;
            border-radius: 20px; padding: 20px 30px; width: 300px; text-align: center;
            color: #fff; font-family: 'Dancing Script', cursive; font-size: 1.8rem;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.8); white-space: pre-wrap;
        }
        .img-box {
            z-index: 45; padding: 8px; background: #ff1493; border-radius: 15px;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.5); width: 250px; min-height: 150px; 
            display: flex; justify-content: center; align-items: center;
        }
        .img-box img { width: 100%; display: block; border-radius: 10px; }
        
        /* --- CAMERA & OVERLAY --- */
        #camera-box {
            position: absolute; bottom: 20px; right: 20px; width: 160px; height: 120px;
            z-index: 90; border: 2px solid #ff00aa; border-radius: 10px; overflow: hidden;
            background: #000; transform: scaleX(-1); display: none; opacity: 0.7;
        }
        .input_video { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
        #camera-overlay { position: absolute; top:0; left:0; width:100%; height:100%; }

        /* --- 3D LETTER STYLES --- */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            display: none; justify-content: center; align-items: center;
            perspective: 1500px; pointer-events: none; 
        }

        .book-wrapper {
            position: relative; 
            width: 750px; height: 500px; 
            /* Cáº­p nháº­t responsive cÆ¡ báº£n */
            max-width: 95vw; max-height: 80vh; 
            transform-style: preserve-3d; 
            transition: transform 1s ease-in-out, width 0.5s, height 0.5s;
            animation: cardFloatUp 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            pointer-events: auto; 
            flex-shrink: 0; margin: auto;
        }
        @keyframes cardFloatUp { from { transform: translateY(100vh); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        @keyframes glowPulse {
            from { box-shadow: 0 0 20px rgba(255, 20, 147, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 20, 147, 1), 0 0 60px rgba(255, 105, 180, 0.8); }
        }
        
        .book-page {
            position: absolute; top: 0; bottom: 0; width: 50%; height: 100%;
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s;
            transform-origin: left center; backface-visibility: hidden;
            box-shadow: 0 0 20px rgba(255, 20, 147, 0.5);
            animation: glowPulse 2s infinite alternate;
            background-color: #fff;
        }

        /* BÃ¬a TrÆ°á»›c - CÄƒn chá»‰nh chÃ­nh xÃ¡c chá»¯ For My Love */
        .cover-front {
            left: 50%; z-index: 20;
            background: url('res/image/love1.png') center/cover no-repeat;
            background-color: #ffb6c1; 
            border-radius: 0 15px 15px 0;
            position: absolute; 
            transform: rotateY(0deg); 
            border: 8px double #ff69b4; border-left: none; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
        }

        .cover-front::after {
            content: "For My Love"; 
            font-family: 'Great Vibes', cursive; font-size: 4rem; color: #fff; 
            text-shadow: 0 0 10px #ff0000;
            background: rgba(0,0,0,0.4); padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            text-align: center; width: fit-content; margin: 0 auto;
        }

        /* Trang Pháº£i (Ná»™i dung) */
        .page-right {
            right: 0; z-index: 10; background: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; box-sizing: border-box; text-align: center;
            font-family: 'Nunito', sans-serif; color: #d63384;
            border: 8px double #ff69b4; border-left: none; border-radius: 0 15px 15px 0;
            overflow: hidden;
            position: absolute;
        }

        /* Trang TrÃ¡i (áº¢nh) */
        .page-left {
            left: 0; z-index: 10; background: #fff5ee;
            border-radius: 15px 0 0 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px; box-sizing: border-box;
            border: 8px double #ff69b4; border-right: none;
            opacity: 0; 
            transform: rotateY(0deg); 
            position: absolute;
        }
        .page-left img {
            width: 85%; height: 42%; object-fit: cover; margin: 10px 0;
            border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: rotate(-3deg);
        }
        .page-left img:last-child { transform: rotate(3deg); }

        /* Tráº¡ng thÃ¡i Má»Ÿ */
        .book-wrapper.open .cover-front { transform: rotateY(-180deg); opacity: 0; pointer-events: none; }
        .book-wrapper.open .page-left { opacity: 1; }
        
        .text-content {
            font-size: 1.4rem; line-height: 1.6; font-weight: 600;
            margin-bottom: 25px; min-height: 180px; width: 90%;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 1px rgba(214, 51, 132, 0.1);
            position: relative; z-index: 2; overflow-y: auto;
        }
        
        .ctrl-btn {
            margin-top: 15px; padding: 10px 25px; border: none; background: #ff1493; color: white;
            font-family: 'Nunito', sans-serif; font-weight: bold; border-radius: 25px; cursor: pointer;
            box-shadow: 0 3px 10px rgba(255,20,147,0.4); transition: 0.2s; font-size: 1.1rem;
            position: relative; z-index: 100;
        }
        .ctrl-btn:hover { background: #ff007f; transform: scale(1.05); }
        .reset-btn { background: #444; margin-top: 15px; font-size: 1rem; }
        .reset-btn:hover { background: #666; }

        #letter-controls {
            position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; opacity: 0; transition: opacity 0.5s; 
            pointer-events: auto; z-index: 210;
        }
        #btn-open-letter {
             padding: 18px 50px; font-size: 1.8rem; background: #ff0055; color: white; border: none; border-radius: 50px;
             box-shadow: 0 0 25px #ff0055; cursor: pointer; animation: pulse 2s infinite; white-space: nowrap;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* --- TRÃI TIM BAY --- */
        .heart-particle {
            position: absolute; bottom: 0; font-size: 24px; color: #ff0055;
            user-select: none; pointer-events: none; z-index: 1; 
            animation: heartFly 3s linear forwards; opacity: 0;
        }

        @keyframes heartFly {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 0.8; transform: translateY(-20px) scale(1); }
            100% { transform: translateY(-350px) scale(1.2) rotate(var(--rotation)); opacity: 0; }
        }

        /* ==========================================================================
           TÃ™Y CHá»ˆNH CHO ÄIá»†N THOáº I (LANDSCAPE MODE)
           Sá»­ dá»¥ng khi chiá»u cao mÃ n hÃ¬nh nhá» hÆ¡n 600px (thÆ°á»ng lÃ  Ä‘iá»‡n thoáº¡i xoay ngang)
           ========================================================================== */
        @media screen and (max-height: 600px) and (orientation: landscape) {
            /* 1. NÃºt báº¯t Ä‘áº§u nhá» láº¡i */
            #start-btn { font-size: 1rem; padding: 10px 25px; }

            /* 2. Chá»¯ chÃ o má»«ng & Äáº¿m ngÆ°á»£c: DÃ¹ng vh Ä‘á»ƒ scale theo chiá»u cao */
            .greet-line1 { font-size: 10vh; margin-bottom: 2px; }
            .greet-line2 { font-size: 12vh; letter-spacing: 1px; }
            #countdown-number { font-size: 35vh; margin-top: 5px; }
            #guide-text { font-size: 5vh; bottom: 5%; }
            #finale-timer { font-size: 6vh; bottom: 10px; }

            /* 3. Camera thu nhá» gÃ³c pháº£i */
            #camera-box { 
                width: 120px; height: 90px; 
                bottom: 5px; right: 5px; 
                border-width: 1px;
            }

            /* 4. Tin nháº¯n & áº¢nh trÃ´i: Giáº£m kÃ­ch thÆ°á»›c */
            .msg-box { width: 35vw; padding: 5px 10px; font-size: 4vh; border-radius: 10px; }
            .img-box { width: 30vw; min-height: 20vh; padding: 4px; border-radius: 8px; }

            /* 5. CUá»N SÃCH / THIá»†P - QUAN TRá»ŒNG NHáº¤T */
            .book-wrapper {
                /* TÃ­nh toÃ¡n láº¡i theo chiá»u cao mÃ n hÃ¬nh (vh) Ä‘á»ƒ khÃ´ng bá»‹ trÃ n */
                height: 75vh; 
                /* Giá»¯ tá»· lá»‡ khung hÃ¬nh ~1.5 (giá»‘ng 750/500 gá»‘c) */
                width: 112.5vh; 
                /* Äáº£m báº£o khÃ´ng quÃ¡ rá»™ng so vá»›i mÃ n hÃ¬nh */
                max-width: 85vw;
            }

            .cover-front::after { font-size: 10vh; padding: 1vh 2vh; }
            
            .page-right { padding: 10px; }
            .text-content { 
                font-size: 4.5vh; /* Chá»¯ trong thÆ° scale theo chiá»u cao */
                min-height: auto; 
                margin-bottom: 1vh;
                line-height: 1.3;
            }
            
            .ctrl-btn { padding: 1vh 3vh; font-size: 4vh; margin-top: 5px; }
            #btn-open-letter { font-size: 5vh; padding: 1.5vh 4vh; }
            #letter-controls { bottom: 5%; }

            /* áº¢nh trong thiá»‡p */
            .page-left { padding: 5px; }
            .page-left img { height: 40%; margin: 2px 0; border-width: 2px; }
        }

    </style>
</head>
<body>

    <div id="landing-screen">
        <button id="start-btn">Nháº¥n Ä‘á»ƒ báº¯t Ä‘áº§u Ä‘áº¿m ngÆ°á»£c</button>
    </div>
    <div id="loading">Äang táº£i há»‡ thá»‘ng...</div>

    <div id="bg-image-layer">
        <img src="res/image/back.png" alt="Background" onerror="this.style.display='none'">
    </div>
    <canvas id="canvas-bg"></canvas>

    <div id="camera-box">
        <video class="input_video" playsinline></video>
        <canvas id="camera-overlay"></canvas>
    </div>

    <div id="ui-layer">
        <div id="greeting-box">
            <div class="greet-line1">ChÃºc má»«ng nÄƒm má»›i nhÃ©</div>
            <div class="greet-line2">Ngá»c Linh !</div>
        </div>

        <div id="countdown-number">5</div>
        
        <div id="guide-text"></div>
        
        <div id="finale-timer"></div>
    </div>

    <div id="floating-container"></div>

    <div id="letter-container">
        <div class="book-wrapper" id="the-book">
            <div class="book-page cover-front"></div>
            <div class="book-page page-left">
                <img src="res/image/love1.png" alt="Love 1">
                <img src="res/image/love2.jpg" alt="Love 2">
            </div>
            
            <div class="book-page page-right" id="letter-content-page">
                <div class="text-content" id="letter-text">Loading message...</div>
                <button class="ctrl-btn" id="btn-next-msg">Äá»c tiáº¿p â¤ï¸</button>
                <button class="ctrl-btn" id="btn-close-letter" style="display:none;">ÄÃ³ng thiá»‡p</button>
            </div>
        </div>
        
        <div id="letter-controls">
            <button id="btn-open-letter">Má»Ÿ Thiá»‡p ğŸ’Œ</button>
            <button class="ctrl-btn reset-btn" id="btn-reset-game" style="display:none;">LÃ m láº¡i tá»« Ä‘áº§u â†»</button>
        </div>
    </div>

    <script>
        // --- Cáº¤U HÃŒNH ---
        const FINALE_DURATION = 100000; // ms (Thá»i gian trÃ´i áº£nh/nháº¡c)

        // --- Ã‚M THANH SYSTEM ---
        const AUDIO = {
            bgIntro: new Audio('res/sound/bg_intro.mp3'),
            bgFinale: new Audio('res/sound/bg_finale.mp3'),
            bgLetter: new Audio('res/sound/bg_letter.mp3'),
            count5: new Audio('res/sound/count_5.mp3'),
            count4: new Audio('res/sound/count_4.mp3'),
            count3: new Audio('res/sound/count_3.mp3'),
            count2: new Audio('res/sound/count_2.mp3'),
            count1: new Audio('res/sound/count_1.mp3'),
            whistle: new Audio('res/sound/whistle.mp3'),
            boom: new Audio('res/sound/boom.mp3')
        };

        AUDIO.bgIntro.loop = true; AUDIO.bgIntro.volume = 0.4;
        AUDIO.bgFinale.loop = true; AUDIO.bgFinale.volume = 0.8;
        AUDIO.bgLetter.loop = true; AUDIO.bgLetter.volume = 0.7;
        
        AUDIO.count5.volume = 1.0; AUDIO.count4.volume = 1.0;
        AUDIO.count3.volume = 1.0; AUDIO.count2.volume = 1.0;
        AUDIO.count1.volume = 1.0; AUDIO.whistle.volume = 1.0; AUDIO.boom.volume = 1.0;

        function playCountSound(num) {
            [AUDIO.count5, AUDIO.count4, AUDIO.count3, AUDIO.count2, AUDIO.count1].forEach(a => {
                a.pause(); a.currentTime = 0;
            });
            if(num === 5) AUDIO.count5.play();
            if(num === 4) AUDIO.count4.play();
            if(num === 3) AUDIO.count3.play();
            if(num === 2) AUDIO.count2.play();
            if(num === 1) AUDIO.count1.play();
        }

        function fadeOutAudio(audio, duration = 1500) {
            if (audio.paused) return;
            const originalVolume = audio.volume;
            const stepTime = 50;
            const step = originalVolume / (duration / stepTime);
            
            const fadeInterval = setInterval(() => {
                if (audio.volume > step) {
                    audio.volume -= step;
                } else {
                    audio.volume = 0;
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = originalVolume; 
                    clearInterval(fadeInterval);
                }
            }, stepTime);
        }

        // --- Dá»® LIá»†U ---
        
        // 50 Lá»i chÃºc má»›i dÃ nh riÃªng cho Linh
        const MESSAGES = [
            "ğŸŒ¸ Happy New Year 2026 Linh xinh Ä‘áº¹p! ğŸŒ¸",
            "NÄƒm má»›i chÃºc Linh mÃ£i ráº¡ng ngá»i nhÆ° Ã¡nh ban mai â˜€ï¸",
            "Linh Æ¡i, nÄƒm nay pháº£i tháº­t háº¡nh phÃºc nhÃ©! â¤ï¸",
            "ChÃºc Linh tiá»n vá» Ä‘áº§y tÃºi, tÃ¬nh Ä‘áº§y tim ğŸ’°",
            "LuÃ´n giá»¯ ná»¥ cÆ°á»i tá»a náº¯ng áº¥y nhÃ© Linh ğŸ˜Š",
            "NÄƒm 2026 bÃ¹ng ná»• nhan sáº¯c nha cÃ´ gÃ¡i! ğŸ’ƒ",
            "ChÃºc Linh váº¡n sá»± nhÆ° Ã½, tá»‰ sá»± nhÆ° mÆ¡ ğŸŒŸ",
            "Má»—i ngÃ y cá»§a Linh Ä‘á»u lÃ  má»™t ngÃ y vui ğŸ‰",
            "Cáº£m Æ¡n vÃ¬ Linh Ä‘Ã£ luÃ´n á»Ÿ bÃªn tá»› ğŸ’•",
            "NÄƒm má»›i bá»›t lo Ã¢u, thÃªm tháº­t nhiá»u niá»m vui ğŸ˜„",
            "Linh lÃ  cÃ´ gÃ¡i tuyá»‡t vá»i nháº¥t tá»› tá»«ng gáº·p ğŸŒ¹",
            "ChÃºc Linh sá»± nghiá»‡p thÄƒng tiáº¿n vÃ¹ vÃ¹ ğŸš€",
            "Äi Ä‘Ã¢u cÅ©ng gáº·p may máº¯n nha Linh Æ¡i ğŸ€",
            "ChÃºc Linh Äƒn mÃ£i khÃ´ng bÃ©o, luÃ´n xinh tÆ°Æ¡i ğŸ•",
            "NÄƒm má»›i, thÃ nh cÃ´ng má»›i rá»±c rá»¡ nhÃ© Linh! ğŸ†",
            "MÃ£i lÃ  bÃ´ng hoa xinh Ä‘áº¹p nháº¥t nhÃ© ğŸŒº",
            "ChÃºc Linh tÃ¬m Ä‘Æ°á»£c háº¡nh phÃºc trá»n váº¹n ğŸ’–",
            "Linh Æ¡i, máº¡nh máº½ vÃ  kiÃªn cÆ°á»ng lÃªn nhÃ© ğŸ’ª",
            "NÄƒm nay há»©a háº¹n nhiá»u Ä‘iá»u tuyá»‡t vá»i vá»›i Linh âœ¨",
            "ChÃºc Linh luÃ´n Ä‘Æ°á»£c yÃªu thÆ°Æ¡ng vÃ  che chá»Ÿ â˜‚ï¸",
            "Sá»©c khá»e dá»“i dÃ o Ä‘á»ƒ Ä‘i kháº¯p tháº¿ giá»›i ğŸŒ",
            "NÄƒm má»›i bÃ¬nh an, tÃ¢m há»“n thÆ° thÃ¡i nhÃ© Linh ğŸƒ",
            "ChÃºc Linh luÃ´n tá»± tin vÃ  tá»a sÃ¡ng ğŸ’",
            "Mong má»i Æ°á»›c mÆ¡ cá»§a Linh thÃ nh hiá»‡n thá»±c ğŸŒˆ",
            "NÄƒm 2026 rá»±c rá»¡ sáº¯c mÃ u nhÃ© Linh! ğŸ¨",
            "LÃºc nÃ o má»‡t má»i, nhá»› lÃ  cÃ³ tá»› á»Ÿ Ä‘Ã¢y ğŸ¤",
            "ChÃºc Linh xinh Ä‘áº¹p báº¥t cháº¥p thá»i gian â³",
            "TÃ¬nh duyÃªn phÆ¡i phá»›i nhÃ© cÃ´ nÃ ng xinh Ä‘áº¹p ğŸ’•",
            "Linh cÆ°á»i lÃªn lÃ  tháº¿ giá»›i bá»«ng sÃ¡ng Ä‘áº¥y ğŸ˜",
            "ChÃºc má»«ng nÄƒm má»›i ngÆ°á»i báº¡n Ä‘áº·c biá»‡t! ğŸ¥‚",
            "NÄƒm nay nháº¥t Ä‘á»‹nh pháº£i giÃ u to nhÃ© Linh ğŸ’¸",
            "Háº¡nh phÃºc ngáº­p trÃ n, yÃªu thÆ°Æ¡ng lai lÃ¡ng ğŸ¥°",
            "ChÃºc Linh má»™t nÄƒm Ä‘Ã¡ng nhá»› nháº¥t thanh xuÃ¢n ğŸ“¸",
            "LuÃ´n giá»¯ vá»¯ng Ä‘am mÃª chÃ¡y bá»ng nhÃ© ğŸ”¥",
            "NÄƒm má»›i, khá»Ÿi Ä‘áº§u má»›i tháº­t thuáº­n lá»£i ğŸ€",
            "ChÃºc Linh gáº·p Ä‘Æ°á»£c ngÆ°á»i trÃ¢n trá»ng mÃ¬nh â¤ï¸",
            "Má»—i sÃ¡ng thá»©c dáº­y Ä‘á»u lÃ  niá»m vui má»›i â˜€ï¸",
            "Linh xá»©ng Ä‘Ã¡ng vá»›i nhá»¯ng Ä‘iá»u tá»‘t Ä‘áº¹p nháº¥t ğŸ",
            "NÄƒm má»›i sang cháº£nh, tháº§n thÃ¡i ngÃºt ngÃ n ğŸ‘‘",
            "ChÃºc Linh luÃ´n yÃªu Ä‘á»i, yÃªu ngÆ°á»i ğŸ’—",
            "Má»i khÃ³ khÄƒn sáº½ qua, chá»‰ cÃ²n niá»m vui á»Ÿ láº¡i ğŸŒˆ",
            "Linh lÃ  Ä‘iá»u ngá»t ngÃ o cá»§a nÄƒm má»›i ğŸ¬",
            "ChÃºc Linh cÃ´ng viá»‡c hanh thÃ´ng, thuáº­n lá»£i ğŸ“ˆ",
            "NÄƒm nay Ä‘i du lá»‹ch tháº­t nhiá»u nhÃ© Linh âœˆï¸",
            "MÃ£i bÃªn nhau báº¡n nhÃ©! ğŸ’",
            "ChÃºc Linh ngá»§ ngon, mÆ¡ Ä‘áº¹p má»—i tá»‘i ğŸŒ™",
            "NÄƒm má»›i chÃºc Linh luÃ´n an nhiÃªn tá»± táº¡i ğŸŒ¼",
            "Gá»­i ngÃ n ná»¥ hÃ´n giÃ³ tá»›i Linh ğŸ˜˜",
            "YÃªu thÆ°Æ¡ng Linh ráº¥t nhiá»u! ğŸ’–",
            "Happy New Year 2026 - NÄƒm cá»§a Linh! ğŸ†"
        ];

        // Táº¡o máº£ng áº£nh Ä‘á»™ng tá»« NL1.JPG Ä‘áº¿n NL50.JPG
        const BASE_IMAGES = ["res/image/love1.png", "res/image/love2.jpg", "res/image/back.png"];
        const NL_IMAGES = [];
        for (let i = 1; i <= 50; i++) {
            NL_IMAGES.push(`res/image/NL${i}.jpg`);
        }
        
        const IMAGES = [...BASE_IMAGES, ...NL_IMAGES];
        const FLOATING_IMAGES = NL_IMAGES;

        const LETTER_MESSAGES = [
            "Gá»­i Ngá»c Linh,\nNÄƒm má»›i Ä‘Ã£ Ä‘áº¿n rá»“i, anh muá»‘n gá»­i Ä‘áº¿n em nhá»¯ng lá»i chÃºc tá»‘t Ä‘áº¹p nháº¥t. Cáº£m Æ¡n em vÃ¬ Ä‘Ã£ xuáº¥t hiá»‡n vÃ  lÃ m cuá»™c sá»‘ng cá»§a anh trá»Ÿ nÃªn rá»±c rá»¡ hÆ¡n bao giá» háº¿t. ğŸŒ¹",
            "NÄƒm 2026 nÃ y, anh mong em sáº½ luÃ´n cÆ°á»i tháº­t tÆ°Æ¡i, Ä‘áº¡t Ä‘Æ°á»£c má»i Æ°á»›c mÆ¡ mÃ  em áº¥p á»§. DÃ¹ cÃ³ chuyá»‡n gÃ¬ xáº£y ra, hÃ£y nhá»› ráº±ng luÃ´n cÃ³ anh á»Ÿ phÃ­a sau á»§ng há»™ em háº¿t mÃ¬nh. ğŸ’ªâ¤ï¸",
            "YÃªu em ráº¥t nhiá»u! ChÃºc má»«ng nÄƒm má»›i, cÃ´ gÃ¡i tuyá»‡t vá»i nháº¥t cá»§a anh. HÃ£y cÃ¹ng nhau táº¡o nÃªn tháº­t nhiá»u ká»· niá»‡m Ä‘áº¹p ná»¯a nhÃ©! ğŸ’‘âœ¨"
        ];

        // --- GLOBAL VARIABLES & SELECTORS ---
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const overlayCanvas = document.getElementById('camera-overlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        const videoElement = document.getElementsByClassName('input_video')[0];
        const landingScreen = document.getElementById('landing-screen');
        const startBtn = document.getElementById('start-btn');
        const loadingText = document.getElementById('loading');
        const bgLayer = document.getElementById('bg-image-layer');
        const cameraBox = document.getElementById('camera-box');
        const uiLayer = document.getElementById('ui-layer');
        const countDisplay = document.getElementById('countdown-number');
        const greetingBox = document.getElementById('greeting-box');
        const guideText = document.getElementById('guide-text');
        const floatContainer = document.getElementById('floating-container');
        const finaleTimer = document.getElementById('finale-timer'); 

        const letterContainer = document.getElementById('letter-container');
        const theBook = document.getElementById('the-book');
        const letterControls = document.getElementById('letter-controls');
        const btnOpenLetter = document.getElementById('btn-open-letter');
        const btnNextMsg = document.getElementById('btn-next-msg');
        const btnCloseLetter = document.getElementById('btn-close-letter');
        const btnResetGame = document.getElementById('btn-reset-game');
        const letterText = document.getElementById('letter-text');
        const letterPageRight = document.getElementById('letter-content-page'); 

        let appState = 'LANDING'; 
        let targetNumber = 5; 
        let fireworks = [];
        let stars = [];
        let floatInterval;
        let finaleTimerInterval; 
        let floatIndex = 0;
        let finaleOngoing = false;
        let isResetting = false;
        let shuffledImages = [];
        
        let screenFlash = 0; 
        let flashColor = '255, 105, 180';
        let currentLetterPage = 0;
        let heartInterval;

        // --- INIT & RESIZE ---
        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            // Cáº­p nháº­t Ä‘á»™ phÃ¢n giáº£i overlay Ä‘á»ƒ khá»›p vá»›i camera, CSS sáº½ lo pháº§n hiá»ƒn thá»‹
            overlayCanvas.width = 160; overlayCanvas.height = 120;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CLASS HIá»†U á»¨NG ---
        class Star {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2; this.alpha = Math.random(); this.blink = Math.random() * 0.02;
            }
            draw() { ctx.fillStyle = `rgba(255,255,255,${this.alpha})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
            update() { this.alpha += this.blink; if(this.alpha <= 0 || this.alpha >= 1) this.blink *= -1; }
        }
        for(let i=0; i<150; i++) stars.push(new Star());

        class Firework {
            constructor(startX, startY, targetY, type = 'normal') {
                this.x = startX; this.y = startY; this.targetY = targetY; this.type = type;
                if (type === 'big-opener') { this.speed = 4.5; } else { this.speed = Math.random() * 4 + 10; }
                this.particles = []; this.exploded = false;
                if(type === 'big-opener') {
                    this.hue = 340; 
                    AUDIO.whistle.currentTime = 0; AUDIO.whistle.play().catch(e => console.log(e));
                } else if (type === 'finale-round') {
                    this.hue = Math.random() * 360; 
                } else { this.hue = Math.random() * 360; }
            }
            update() {
                if(!this.exploded) {
                    this.y -= this.speed; 
                    if (this.type === 'big-opener') { this.speed *= 0.998; } else { this.speed *= 0.95; }
                    if(this.type === 'big-opener') { ctx.fillStyle = 'rgba(255,100,150,0.8)'; ctx.beginPath(); ctx.arc(this.x, this.y + 10, 3, 0, Math.PI*2); ctx.fill(); }
                    if(this.y <= this.targetY || this.speed <= 1) this.explode();
                } else {
                    this.particles.forEach((p,i) => { p.update(); if(p.alpha <= 0) this.particles.splice(i,1); });
                }
            }
            explode() {
                this.exploded = true;
                if(this.type === 'finale-round' || this.type === 'big-opener') {
                    screenFlash = 5;
                    const flashColors = [ '255, 20, 147', '255, 0, 0', '148, 0, 211', '255, 105, 180' ];
                    flashColor = flashColors[Math.floor(Math.random() * flashColors.length)];
                }
                if (this.type === 'big-opener') {
                    AUDIO.boom.currentTime = 0; AUDIO.boom.play().catch(e => console.log(e));
                    const particleCount = 600;
                    for(let i=0; i < particleCount; i++) {
                        const t = (Math.PI * 2 * i) / particleCount;
                        const dx = 16 * Math.pow(Math.sin(t), 3);
                        const dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                        const hue = 320 + Math.random() * 40; 
                        const p = new Particle(this.x, this.y, hue, 0); 
                        const scale = 0.9 + Math.random() * 0.2; 
                        p.vx = dx * scale; p.vy = (dy - 5) * scale;
                        p.gravity = 0.05; p.friction = 0.96; p.decay = 0.005; p.sparkle = true;  
                        this.particles.push(p);
                    }
                } else {
                    let count = (this.type === 'finale-round') ? 300 : 40; 
                    let spread = (this.type === 'finale-round') ? 15 : 5;
                    for(let i=0; i<count; i++) this.particles.push(new Particle(this.x, this.y, this.hue, spread));
                }
            }
            draw() {
                if(!this.exploded) { ctx.fillStyle = (this.type === 'big-opener') ? '#fff' : `hsl(${this.hue}, 100%, 60%)`; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); }
                else { this.particles.forEach(p => p.draw()); }
            }
        }

        class Particle {
            constructor(x, y, hue, spreadSpeed) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2; const speed = Math.random() * spreadSpeed + 1; 
                this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                this.alpha = 1; this.friction = 0.96; this.gravity = 0.04;
                this.decay = Math.random() * 0.008 + 0.004; this.hue = hue; this.sparkle = Math.random() < 0.5; 
            }
            update() {
                this.vx *= this.friction; this.vy *= this.friction;
                this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.alpha -= this.decay;
            }
            draw() {
                ctx.save(); ctx.globalCompositeOperation = 'lighter';
                let currentAlpha = this.alpha; if(this.sparkle) currentAlpha *= (0.5 + Math.random() * 0.5); 
                ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${currentAlpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        function animateCanvas() {
            if (screenFlash > 0) {
                ctx.fillStyle = `rgba(${flashColor}, ${screenFlash * 0.015})`; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                screenFlash--;
            } else {
                ctx.fillStyle = 'rgba(0,0,0,0.2)'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            if(appState !== 'LANDING') stars.forEach(s => { s.update(); s.draw(); });
            if(appState === 'COUNTDOWN' && Math.random() < 0.05) {
                fireworks.push(new Firework(Math.random() * canvas.width, canvas.height, Math.random() * (canvas.height * 0.5), 'normal'));
            }
            
            if(finaleOngoing && Math.random() < 0.08) { 
                fireworks.push(new Firework(
                    Math.random() * canvas.width, 
                    canvas.height, 
                    canvas.height * 0.05 + Math.random() * (canvas.height * 0.5), 
                    'finale-round'
                ));
            }

            fireworks.forEach((fw, i) => {
                fw.update(); fw.draw(); if(fw.exploded && fw.particles.length === 0) fireworks.splice(i,1);
            });
            requestAnimationFrame(animateCanvas);
        }
        animateCanvas();

        // --- PRELOAD LOGIC ---
        let imagesLoaded = 0;
        let totalImages = 0;

        function preloadAllImages() {
            totalImages = IMAGES.length;
            return new Promise((resolve) => {
                if (totalImages === 0) resolve();
                IMAGES.forEach((src) => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        imagesLoaded++;
                        loadingText.innerText = `Äang táº£i tÃ i nguyÃªn... ${Math.floor((imagesLoaded / totalImages) * 100)}%`;
                        if (imagesLoaded === totalImages) resolve();
                    };
                    img.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) resolve(); };
                });
            });
        }

        // --- GAME START LOGIC ---
        startBtn.addEventListener('click', async () => {
            AUDIO.bgIntro.play().catch(e => console.log("Cáº§n tÆ°Æ¡ng tÃ¡c ngÆ°á»i dÃ¹ng Ä‘á»ƒ phÃ¡t nháº¡c"));
            landingScreen.style.opacity = 0; 
            setTimeout(() => landingScreen.style.display = 'none', 500);
            
            loadingText.style.display = 'block';
            loadingText.innerText = "Äang khá»Ÿi Ä‘á»™ng Camera & Táº£i áº£nh...";

            await Promise.all([initCamera(), preloadAllImages()]);
            
            loadingText.style.display = 'none'; 
            cameraBox.style.display = 'block';
            appState = 'WAITING'; 
            guideText.innerText = "GiÆ¡ 5 ngÃ³n tay Ä‘á»ƒ báº¯t Ä‘áº§u...";
        });

        async function initCamera() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
            hands.onResults(onResults);
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480
            });
            await camera.start();
        }

        function countFingers(landmarks) {
            let count = 0;
            if (landmarks[8].y < landmarks[6].y) count++;
            if (landmarks[12].y < landmarks[10].y) count++;
            if (landmarks[16].y < landmarks[14].y) count++;
            if (landmarks[20].y < landmarks[18].y) count++;
            const isRight = landmarks[17].x > landmarks[5].x;
            if ((isRight && landmarks[4].x < landmarks[3].x) || (!isRight && landmarks[4].x > landmarks[3].x)) count++;
            return count;
        }

        function onResults(results) {
            overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                drawConnectors(overlayCtx, lm, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 2});
                drawLandmarks(overlayCtx, lm, {color: '#ff0000', lineWidth: 1});
                const fingers = countFingers(lm);
                processGameLogic(fingers);
            } else {
                if(appState === 'COUNTDOWN') {
                    if (!isResetting) resetGame();
                }
            }
        }

        function processGameLogic(fingers) {
            if (isResetting) return; 
            if (appState === 'WAITING') {
                if(fingers === 5) startCountdown();
            } 
            else if (appState === 'COUNTDOWN') {
                if(fingers === targetNumber - 1) {
                    targetNumber = fingers;
                    if(targetNumber > 0) {
                        updateCountdownDisplay(targetNumber);
                    } else {
                        startFinaleSequence();
                    }
                }
            }
        }

        function startCountdown() {
            appState = 'COUNTDOWN'; targetNumber = 5;
            bgLayer.style.opacity = 0;
            guideText.style.bottom = '10%'; guideText.innerText = "Giá»¯ tay vÃ  Ä‘áº¿m ngÆ°á»£c dáº§n xuá»‘ng...";
            greetingBox.style.display = 'block'; countDisplay.style.display = 'block';
            updateCountdownDisplay(5);
        }

        function updateCountdownDisplay(num) {
            countDisplay.innerText = num;
            countDisplay.classList.remove('pop-anim'); void countDisplay.offsetWidth; countDisplay.classList.add('pop-anim');
            playCountSound(num);
        }

        // --- FINALE SEQUENCE ---
        function startFinaleSequence() {
            if(appState === 'FINALE') return;
            appState = 'FINALE';
            
            fadeOutAudio(AUDIO.bgIntro);
            
            greetingBox.classList.add('fade-out-transition');
            countDisplay.classList.add('fade-out-transition');
            guideText.classList.add('fade-out-transition');

            setTimeout(() => {
                greetingBox.style.display = 'none';
                countDisplay.style.display = 'none';
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.innerText = "HÃ£y táº­n hÆ°á»Ÿng khoáº£nh kháº¯c nÃ y..."; 
                setTimeout(() => guideText.style.opacity = 0, 5000);
            }, 1500);

            fireworks = []; 

            setTimeout(() => {
                fireworks.push(new Firework(canvas.width / 2, canvas.height, canvas.height * 0.35, 'big-opener'));
                setTimeout(() => {
                    AUDIO.bgFinale.play().catch(e => console.log(e));
                    
                    floatContainer.style.display = 'block';
                    floatContainer.style.opacity = '1';
                    
                    spawnFloatingItem(); 
                    if(floatInterval) clearInterval(floatInterval);
                    floatInterval = setInterval(spawnFloatingItem, 2500);
                    finaleOngoing = true; 

                    let remainingSeconds = Math.floor(FINALE_DURATION / 1000);
                    finaleTimer.style.display = 'block';
                    finaleTimer.style.opacity = 1;
                    finaleTimer.innerText = `Táº­n hÆ°á»Ÿng nhÃ© báº¡n yÃªu: ${remainingSeconds}s`;

                    if(finaleTimerInterval) clearInterval(finaleTimerInterval);
                    finaleTimerInterval = setInterval(() => {
                        remainingSeconds--;
                        if(remainingSeconds > 0) {
                            finaleTimer.innerText = `Táº­n hÆ°á»Ÿng nhÃ© báº¡n yÃªu: ${remainingSeconds}s`;
                        } else {
                            finaleTimer.innerText = `Táº­n hÆ°á»Ÿng nhÃ© báº¡n yÃªu: 0s`;
                            clearInterval(finaleTimerInterval);
                        }
                    }, 1000);

                    setTimeout(endFinaleAndStartLetter, FINALE_DURATION);

                }, 4000); 
            }, 2000); 
        }

        function endFinaleAndStartLetter() {
            finaleOngoing = false; 
            if(floatInterval) clearInterval(floatInterval); 
            if(finaleTimerInterval) clearInterval(finaleTimerInterval); 
            
            finaleTimer.style.opacity = 0;
            setTimeout(() => finaleTimer.style.display = 'none', 1000);

            fadeOutAudio(AUDIO.bgFinale, 3000);
            
            floatContainer.style.opacity = '0';
            setTimeout(() => {
                floatContainer.innerHTML = ''; 
                floatContainer.style.display = 'none';
            }, 3000);

            setTimeout(() => {
                showLetterSequence();
            }, 5000); 
        }

        // --- LETTER LOGIC ---
        function showLetterSequence() {
            appState = 'LETTER';
            letterContainer.style.display = 'flex'; 
            letterControls.style.opacity = 1;
            
            theBook.classList.remove('open');
            currentLetterPage = 0;
            
            btnOpenLetter.style.display = 'block';
            btnOpenLetter.innerText = "Má»Ÿ Thiá»‡p ğŸ’Œ"; 
            btnResetGame.style.display = 'none';
        }

        function spawnHeart() {
            const heart = document.createElement('div');
            heart.classList.add('heart-particle');
            heart.innerHTML = Math.random() < 0.5 ? 'â¤ï¸' : 'ğŸ’—';
            heart.style.left = (Math.random() * 90) + '%';
            heart.style.setProperty('--rotation', (Math.random() * 60 - 30) + 'deg');
            letterPageRight.appendChild(heart);
            setTimeout(() => { if (heart.parentNode) heart.remove(); }, 3500);
        }

        btnOpenLetter.addEventListener('click', () => {
            btnOpenLetter.style.display = 'none'; 
            theBook.classList.add('open'); 
            
            if(AUDIO.bgLetter.paused) {
                AUDIO.bgLetter.play().catch(e=>console.log(e));
            }
            
            currentLetterPage = 0;
            letterText.innerText = LETTER_MESSAGES[0];
            btnNextMsg.style.display = 'inline-block';
            btnCloseLetter.style.display = 'none';

            if (heartInterval) clearInterval(heartInterval);
            spawnHeart(); 
            heartInterval = setInterval(spawnHeart, 800); 
        });

        btnNextMsg.addEventListener('click', () => {
            currentLetterPage++;
            letterText.style.opacity = 0;
            setTimeout(() => {
                if (currentLetterPage < LETTER_MESSAGES.length) {
                    letterText.innerText = LETTER_MESSAGES[currentLetterPage];
                    letterText.style.opacity = 1;
                }
                if (currentLetterPage >= 2) { 
                    btnNextMsg.style.display = 'none';
                    btnCloseLetter.style.display = 'inline-block';
                }
            }, 300);
        });

        btnCloseLetter.addEventListener('click', () => {
            theBook.classList.remove('open'); 
            if (heartInterval) clearInterval(heartInterval);
            const existingHearts = document.querySelectorAll('.heart-particle');
            existingHearts.forEach(h => h.remove());

            setTimeout(() => {
                btnOpenLetter.style.display = 'block';
                btnOpenLetter.innerText = "Má»Ÿ láº¡i ğŸ’Œ";
                btnResetGame.style.display = 'block'; 
            }, 1000); 
        });

        btnResetGame.addEventListener('click', () => {
            fadeOutAudio(AUDIO.bgLetter, 1000);
            resetGame();
        });

        function resetGame() {
            if (isResetting) return;
            isResetting = true; 
            
            if (heartInterval) clearInterval(heartInterval);
            const existingHearts = document.querySelectorAll('.heart-particle');
            existingHearts.forEach(h => h.remove());

            letterContainer.style.display = 'none';
            letterControls.style.opacity = 0;
            floatContainer.style.opacity = '0';
            
            finaleTimer.style.opacity = 0;
            finaleTimer.style.display = 'none';
            if(finaleTimerInterval) clearInterval(finaleTimerInterval);

            if(!AUDIO.bgFinale.paused) fadeOutAudio(AUDIO.bgFinale, 500);

            setTimeout(() => {
                appState = 'WAITING';
                targetNumber = 5;
                finaleOngoing = false;
                
                if(floatInterval) clearInterval(floatInterval);
                floatContainer.innerHTML = '';
                floatContainer.style.display = 'none';
                fireworks = [];
                
                bgLayer.style.opacity = 1;
                
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.style.opacity = 1; 
                
                greetingBox.style.display = 'none'; 
                countDisplay.style.display = 'none';
                guideText.innerText = "GiÆ¡ 5 ngÃ³n tay Ä‘á»ƒ báº¯t Ä‘áº§u...";
                guideText.style.bottom = '15%';

                AUDIO.bgIntro.currentTime = 0;
                AUDIO.bgIntro.volume = 0.4; 
                AUDIO.bgIntro.play().catch(e => console.log("User interaction needed"));

                isResetting = false; 
            }, 1000);
        }

        function spawnFloatingItem() {
            if(appState !== 'FINALE') return;

            if (shuffledImages.length === 0) {
                let indices = Array.from({length: FLOATING_IMAGES.length}, (_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                shuffledImages = indices;
            }

            const uniqueIndex = shuffledImages.pop();
            const layoutType = Math.random() > 0.5 ? 0 : 1; 
            const msgEl = document.createElement('div'); msgEl.classList.add('float-item', 'msg-box');
            msgEl.innerText = MESSAGES[floatIndex % MESSAGES.length];
            const imgEl = document.createElement('div'); imgEl.classList.add('float-item', 'img-box');
            const img = document.createElement('img');
            
            img.src = FLOATING_IMAGES[uniqueIndex]; 
            
            imgEl.appendChild(img);
            
            const randomLeft = 5 + Math.random() * 35; 
            const randomRight = 55 + Math.random() * 35;
            
            if (layoutType === 0) { msgEl.style.left = randomLeft + '%'; imgEl.style.left = randomRight + '%'; } 
            else { msgEl.style.left = randomRight + '%'; imgEl.style.left = randomLeft + '%'; }
            
            floatContainer.appendChild(msgEl); floatContainer.appendChild(imgEl);
            floatIndex++;
            
            setTimeout(() => { if(msgEl.parentNode) msgEl.remove(); }, 15000);
            setTimeout(() => { if(imgEl.parentNode) imgEl.remove(); }, 15000);
        }
    </script>
</body>
</html>