<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Happy New Year 2026 - Special for Ngoc Linh</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        /* Import Font ch·ªØ ƒë·∫πp */
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Dancing+Script:wght@700&family=Orbitron:wght@900&family=Great+Vibes&family=Nunito:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0; background-color: #000; overflow: hidden;
            font-family: 'Nunito', sans-serif; height: 100vh; width: 100vw; user-select: none;
            touch-action: none; /* Ch·∫∑n zoom/k√©o tr√™n mobile */
        }

        /* --- BACKGROUND LAYERS --- */
        #bg-image-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            transition: opacity 2s ease-in-out; background: #000;
        }
        #bg-image-layer img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        #canvas-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background-color: #000;
        }

        /* --- LANDING SCREEN & UI --- */
        #landing-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            display: flex; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); transition: opacity 0.5s;
        }
        #start-btn {
            padding: 20px 50px; font-size: 2rem; font-family: 'Nunito', sans-serif; font-weight: 700;
            color: #fff; background: linear-gradient(45deg, #ff0055, #ff00aa);
            border: 2px solid #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 30px #ff00aa; transition: transform 0.2s, box-shadow 0.2s;
            text-align: center;
        }
        #start-btn:hover { transform: scale(1.1); box-shadow: 0 0 50px #ff00aa; }
        
        #loading {
            position: absolute; top: 60%; left: 50%; transform: translateX(-50%);
            font-family: 'Nunito', sans-serif; color: #fff; font-size: 1.2rem; display: none; z-index: 101;
            text-align: center; width: 100%;
        }

        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 60;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
            transition: opacity 0.5s;
        }
        
        .fade-out-transition { opacity: 0 !important; transition: opacity 1.5s ease-out; }

        #greeting-box { display: none; margin-bottom: 20px; animation: fadeIn 1s ease-out; transition: opacity 1s; width: 100%; }
        .greet-line1 {
            font-family: 'Dancing Script', cursive; font-size: 3.5rem; color: #fff;
            text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff00aa; margin-bottom: 10px;
        }
        .greet-line2 {
            font-family: 'Cinzel', serif; font-size: 4rem; font-weight: bold; color: #ffd700;
            text-transform: uppercase; text-shadow: 0 0 15px #ffd700, 0 0 30px #ff4500; letter-spacing: 3px;
        }
        
        #countdown-number {
            font-family: 'Orbitron', sans-serif; font-size: 15rem; line-height: 1;
            background: linear-gradient(to bottom, #ffffff 0%, #ffd700 50%, #ff8c00 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 50px rgba(255, 215, 0, 0.8));
            display: none; margin-top: 20px;
            transition: opacity 1s;
        }
        .pop-anim { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 60% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        #guide-text {
            position: absolute; bottom: 15%; font-family: 'Nunito', sans-serif; font-weight: 700;
            font-size: 1.5rem; color: rgba(255,255,255,0.9); text-shadow: 0 0 10px #000;
            width: 100%; text-align: center; transition: opacity 1s; padding: 0 10px; box-sizing: border-box;
        }

        #finale-timer {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            text-align: center; z-index: 150; pointer-events: none;
            font-family: 'Dancing Script', cursive; font-size: 2rem; color: #fff;
            text-shadow: 0 0 10px #ff1493, 0 0 20px #ff00aa;
            display: none; opacity: 0; transition: opacity 1s;
        }

        /* --- FLOATING ITEMS --- */
        #floating-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 40;
            overflow: hidden; pointer-events: none; display: none; 
            transition: opacity 2s ease;
        }
        .float-item { 
            position: absolute; top: 100%; will-change: transform; 
            animation: floatUp 15s linear forwards; 
        }
        @keyframes floatUp { 
            0% { transform: translateY(0); opacity: 0; } 
            5% { opacity: 1; } 90% { opacity: 1; } 
            100% { transform: translateY(-150vh); opacity: 0; } 
        }
        .msg-box {
            z-index: 50; background: rgba(20, 0, 10, 0.85); border: 2px solid #ff69b4;
            border-radius: 20px; padding: 20px 30px; width: 300px; text-align: center;
            color: #fff; font-family: 'Dancing Script', cursive; font-size: 1.8rem;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.8); white-space: pre-wrap;
        }
        .img-box {
            z-index: 45; padding: 8px; background: #ff1493; border-radius: 15px;
            box-shadow: 0 0 25px rgba(255, 20, 147, 0.5); width: 250px; min-height: 150px; 
            display: flex; justify-content: center; align-items: center;
        }
        .img-box img { width: 100%; display: block; border-radius: 10px; }
        
        /* --- CAMERA & OVERLAY --- */
        #camera-box {
            position: absolute; bottom: 20px; right: 20px; width: 160px; height: 120px;
            z-index: 90; border: 2px solid #ff00aa; border-radius: 10px; overflow: hidden;
            background: #000; transform: scaleX(-1); display: none; opacity: 0.7;
        }
        .input_video { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; }
        #camera-overlay { position: absolute; top:0; left:0; width:100%; height:100%; }

        /* --- 3D LETTER STYLES --- */
        #letter-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
            display: none; justify-content: center; align-items: center;
            perspective: 1500px; pointer-events: none; 
        }

        .book-wrapper {
            position: relative; width: 750px; height: 500px; 
            transform-style: preserve-3d; 
            transition: transform 1s ease-in-out;
            animation: cardFloatUp 1.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            pointer-events: auto; 
            flex-shrink: 0; margin: auto;
        }
        @keyframes cardFloatUp { from { transform: translateY(100vh); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        @keyframes glowPulse {
            from { box-shadow: 0 0 20px rgba(255, 20, 147, 0.5); }
            to { box-shadow: 0 0 40px rgba(255, 20, 147, 1), 0 0 60px rgba(255, 105, 180, 0.8); }
        }
        
        .book-page {
            position: absolute; top: 0; bottom: 0; width: 50%; height: 100%;
            transition: transform 1.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s;
            transform-origin: left center; backface-visibility: hidden;
            box-shadow: 0 0 20px rgba(255, 20, 147, 0.5);
            animation: glowPulse 2s infinite alternate;
            background-color: #fff;
        }

        /* B√¨a Tr∆∞·ªõc */
        .cover-front {
            left: 50%; z-index: 20;
            background: url('res/image/love1.png') center/cover no-repeat;
            background-color: #ffb6c1; 
            border-radius: 0 15px 15px 0;
            position: absolute; 
            transform: rotateY(0deg); 
            border: 8px double #ff69b4; border-left: none; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
        }

        .cover-front::after {
            content: "For My Love"; 
            font-family: 'Great Vibes', cursive; font-size: 4rem; color: #fff; 
            text-shadow: 0 0 10px #ff0000;
            background: rgba(0,0,0,0.4); padding: 15px 30px; border-radius: 50px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            text-align: center; width: fit-content; margin: 0 auto;
        }

        /* Trang Ph·∫£i (N·ªôi dung) */
        .page-right {
            right: 0; z-index: 10; background: #fff;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; box-sizing: border-box; text-align: center;
            font-family: 'Nunito', sans-serif; color: #d63384;
            border: 8px double #ff69b4; border-left: none; border-radius: 0 15px 15px 0;
            overflow: hidden; position: absolute;
        }

        /* Trang Tr√°i (·∫¢nh) */
        .page-left {
            left: 0; z-index: 10; background: #fff5ee;
            border-radius: 15px 0 0 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 15px; box-sizing: border-box;
            border: 8px double #ff69b4; border-right: none;
            opacity: 0; transform: rotateY(0deg); position: absolute;
        }
        .page-left img {
            width: 85%; height: 42%; object-fit: cover; margin: 10px 0;
            border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: rotate(-3deg);
        }
        .page-left img:last-child { transform: rotate(3deg); }

        .book-wrapper.open .cover-front { transform: rotateY(-180deg); opacity: 0; pointer-events: none; }
        .book-wrapper.open .page-left { opacity: 1; }
        
        .text-content {
            font-size: 1.4rem; line-height: 1.6; font-weight: 600;
            margin-bottom: 25px; min-height: 180px; width: 90%;
            display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 1px rgba(214, 51, 132, 0.1);
            position: relative; z-index: 2; 
        }
        
        .ctrl-btn {
            margin-top: 15px; padding: 10px 25px; border: none; background: #ff1493; color: white;
            font-family: 'Nunito', sans-serif; font-weight: bold; border-radius: 25px; cursor: pointer;
            box-shadow: 0 3px 10px rgba(255,20,147,0.4); transition: 0.2s; font-size: 1.1rem;
            position: relative; z-index: 100;
        }
        .ctrl-btn:hover { background: #ff007f; transform: scale(1.05); }
        .reset-btn { background: #444; margin-top: 15px; font-size: 1rem; }
        .reset-btn:hover { background: #666; }

        #letter-controls {
            position: absolute; bottom: 8%; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; opacity: 0; transition: opacity 0.5s; 
            pointer-events: auto; z-index: 210;
        }
        #btn-open-letter {
             padding: 18px 50px; font-size: 1.8rem; background: #ff0055; color: white; border: none; border-radius: 50px;
             box-shadow: 0 0 25px #ff0055; cursor: pointer; animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Tim bay trong th∆∞ */
        .heart-particle {
            position: absolute; bottom: 0; font-size: 24px; color: #ff0055;
            user-select: none; pointer-events: none; z-index: 1; 
            animation: heartFly 3s linear forwards; opacity: 0;
        }
        @keyframes heartFly {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            10% { opacity: 0.8; transform: translateY(-20px) scale(1); }
            100% { transform: translateY(-350px) scale(1.2) rotate(var(--rotation)); opacity: 0; }
        }

        /* ----------------------------------------------------- */
        /* --- RESPONSIVE MOBILE - D·ªåC & NGANG (ALL MODES) --- */
        /* ----------------------------------------------------- */

        /* 1. ƒêI·ªÜN THO·∫†I D·ªåC (PORTRAIT) */
        @media screen and (orientation: portrait) and (max-width: 768px) {
            #start-btn { font-size: 1.2rem; padding: 15px 30px; width: 80%; }
            .greet-line1 { font-size: 2rem; }
            .greet-line2 { font-size: 2.5rem; letter-spacing: 1px; }
            #countdown-number { font-size: 8rem; margin-top: 10px; }
            #guide-text { font-size: 1rem; bottom: 12%; }

            /* V·∫≠t th·ªÉ bay nh·ªè g·ªçn */
            .msg-box { width: 42vw; padding: 10px; font-size: 0.9rem; border-radius: 10px; white-space: normal; }
            .img-box { width: 40vw; min-height: auto; padding: 4px; }
            .float-item { max-width: 48%; }

            /* Quy·ªÉn s√°ch 3D - D·ªçc th√¨ full chi·ªÅu ngang */
            .book-wrapper { width: 95vw; height: 60vw; }
            .cover-front::after { font-size: 1.8rem; padding: 10px 20px; }
            .text-content { font-size: 0.95rem; line-height: 1.4; min-height: 120px; margin-bottom: 10px; width: 100%; }
            .page-right, .page-left { padding: 10px; border-width: 4px; }
            .page-left img { border-width: 2px; }

            /* ƒêi·ªÅu khi·ªÉn & Camera */
            #letter-controls { bottom: 5%; width: 100%; align-items: center; }
            #btn-open-letter { font-size: 1.2rem; padding: 12px 40px; }
            #camera-box { width: 100px; height: 75px; bottom: 10px; right: 10px; opacity: 0.4; }
            #finale-timer { font-size: 1.2rem; bottom: 80px; }
        }

        /* 2. ƒêI·ªÜN THO·∫†I NGANG (LANDSCAPE) - CH√åA KH√ìA HI·ªÇN TH·ªä GI·ªêNG PC */
        @media screen and (orientation: landscape) and (max-height: 600px) {
            /* ·∫®n b·ªõt UI kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ tho√°ng m√†n h√¨nh */
            #guide-text { bottom: 5%; font-size: 1rem; }
            
            /* T√°i t·∫°o giao di·ªán PC nh∆∞ng Scale theo CHI·ªÄU CAO (vh) */
            .book-wrapper {
                height: 85vh !important; /* Chi·∫øm 85% chi·ªÅu cao m√†n h√¨nh */
                width: 127vh !important; /* T·ª∑ l·ªá 1.5 c·ªßa chi·ªÅu cao (gi·ªØ ƒë√∫ng form ch·ªØ nh·∫≠t) */
                max-width: 90vw; /* Kh√¥ng ƒë·ªÉ tr√†n ngang */
                margin: auto;
            }

            /* Ch·ªØ v√† n·ªôi dung co gi√£n theo chi·ªÅu cao */
            .cover-front::after { font-size: 8vh; padding: 1vh 3vh; }
            .text-content { font-size: 5vh; line-height: 1.3; min-height: auto; margin-bottom: 2vh; }
            
            /* ·∫¢nh b√™n tr√°i */
            .page-left img { width: auto; height: 40%; }
            
            /* N√∫t b·∫•m nh·ªè g·ªçn */
            .ctrl-btn { font-size: 4vh; padding: 1vh 3vh; margin-top: 1vh; }
            #btn-open-letter { font-size: 5vh; padding: 2vh 5vh; }
            
            /* V·∫≠t th·ªÉ bay nh·ªè ƒëi ƒë·ªÉ kh√¥ng che s√°ch */
            .msg-box { width: 30vh; font-size: 3vh; padding: 1vh; }
            .img-box { width: 25vh; min-height: auto; }

            /* Camera n√© sang g√≥c v√† nh·ªè l·∫°i */
            #camera-box {
                width: 15vh; height: 11vh;
                bottom: 5px; right: 5px; opacity: 0.3;
            }
            #finale-timer { font-size: 4vh; bottom: 5px; left: 20px; text-align: left; width: auto; }
            #letter-controls { bottom: 5vh; }
        }

    </style>
</head>
<body>

    <div id="landing-screen">
        <button id="start-btn">Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c</button>
    </div>
    <div id="loading">ƒêang t·∫£i h·ªá th·ªëng...</div>

    <div id="bg-image-layer">
        <img src="res/image/back.png" alt="Background" onerror="this.style.display='none'">
    </div>
    <canvas id="canvas-bg"></canvas>

    <div id="camera-box">
        <video class="input_video" playsinline></video>
        <canvas id="camera-overlay"></canvas>
    </div>

    <div id="ui-layer">
        <div id="greeting-box">
            <div class="greet-line1">Ch√∫c m·ª´ng nƒÉm m·ªõi nh√©</div>
            <div class="greet-line2">Ng·ªçc Linh !</div>
        </div>

        <div id="countdown-number">5</div>
        
        <div id="guide-text"></div>
        
        <div id="finale-timer"></div>
    </div>

    <div id="floating-container"></div>

    <div id="letter-container">
        <div class="book-wrapper" id="the-book">
            <div class="book-page cover-front"></div>
            <div class="book-page page-left">
                <img src="res/image/love1.png" alt="Love 1">
                <img src="res/image/love2.jpg" alt="Love 2">
            </div>
            
            <div class="book-page page-right" id="letter-content-page">
                <div class="text-content" id="letter-text">Loading message...</div>
                <button class="ctrl-btn" id="btn-next-msg">ƒê·ªçc ti·∫øp ‚ù§Ô∏è</button>
                <button class="ctrl-btn" id="btn-close-letter" style="display:none;">ƒê√≥ng thi·ªáp</button>
            </div>
        </div>
        
        <div id="letter-controls">
            <button id="btn-open-letter">M·ªü Thi·ªáp üíå</button>
            <button class="ctrl-btn reset-btn" id="btn-reset-game" style="display:none;">L√†m l·∫°i t·ª´ ƒë·∫ßu ‚Üª</button>
        </div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const FINALE_DURATION = 100000; // ms

        // --- √ÇM THANH SYSTEM ---
        const AUDIO = {
            bgIntro: new Audio('res/sound/bg_intro.mp3'),
            bgFinale: new Audio('res/sound/bg_finale.mp3'),
            bgLetter: new Audio('res/sound/bg_letter.mp3'),
            count5: new Audio('res/sound/count_5.mp3'),
            count4: new Audio('res/sound/count_4.mp3'),
            count3: new Audio('res/sound/count_3.mp3'),
            count2: new Audio('res/sound/count_2.mp3'),
            count1: new Audio('res/sound/count_1.mp3'),
            whistle: new Audio('res/sound/whistle.mp3'),
            boom: new Audio('res/sound/boom.mp3')
        };

        AUDIO.bgIntro.loop = true; AUDIO.bgIntro.volume = 0.4;
        AUDIO.bgFinale.loop = true; AUDIO.bgFinale.volume = 0.8;
        AUDIO.bgLetter.loop = true; AUDIO.bgLetter.volume = 0.7;
        
        AUDIO.count5.volume = 1.0; AUDIO.count4.volume = 1.0;
        AUDIO.count3.volume = 1.0; AUDIO.count2.volume = 1.0;
        AUDIO.count1.volume = 1.0; AUDIO.whistle.volume = 1.0; AUDIO.boom.volume = 1.0;

        function playCountSound(num) {
            [AUDIO.count5, AUDIO.count4, AUDIO.count3, AUDIO.count2, AUDIO.count1].forEach(a => {
                a.pause(); a.currentTime = 0;
            });
            if(num === 5) AUDIO.count5.play();
            if(num === 4) AUDIO.count4.play();
            if(num === 3) AUDIO.count3.play();
            if(num === 2) AUDIO.count2.play();
            if(num === 1) AUDIO.count1.play();
        }

        function fadeOutAudio(audio, duration = 1500) {
            if (audio.paused) return;
            const originalVolume = audio.volume;
            const stepTime = 50;
            const step = originalVolume / (duration / stepTime);
            
            const fadeInterval = setInterval(() => {
                if (audio.volume > step) {
                    audio.volume -= step;
                } else {
                    audio.volume = 0;
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = originalVolume; 
                    clearInterval(fadeInterval);
                }
            }, stepTime);
        }

        // --- D·ªÆ LI·ªÜU ---
        const MESSAGES = [
            "üå∏ Happy New Year 2026 Linh xinh ƒë·∫πp! üå∏",
            "NƒÉm m·ªõi ch√∫c Linh m√£i r·∫°ng ng·ªùi nh∆∞ √°nh ban mai ‚òÄÔ∏è",
            "Linh ∆°i, nƒÉm nay ph·∫£i th·∫≠t h·∫°nh ph√∫c nh√©! ‚ù§Ô∏è",
            "Ch√∫c Linh ti·ªÅn v·ªÅ ƒë·∫ßy t√∫i, t√¨nh ƒë·∫ßy tim üí∞",
            "Lu√¥n gi·ªØ n·ª• c∆∞·ªùi t·ªèa n·∫Øng ·∫•y nh√© Linh üòä",
            "NƒÉm 2026 b√πng n·ªï nhan s·∫Øc nha c√¥ g√°i! üíÉ",
            "Ch√∫c Linh v·∫°n s·ª± nh∆∞ √Ω, t·ªâ s·ª± nh∆∞ m∆° üåü",
            "M·ªói ng√†y c·ªßa Linh ƒë·ªÅu l√† m·ªôt ng√†y vui üéâ",
            "C·∫£m ∆°n v√¨ Linh ƒë√£ lu√¥n ·ªü b√™n t·ªõ üíï",
            "NƒÉm m·ªõi b·ªõt lo √¢u, th√™m th·∫≠t nhi·ªÅu ni·ªÅm vui üòÑ",
            "Linh l√† c√¥ g√°i tuy·ªát v·ªùi nh·∫•t t·ªõ t·ª´ng g·∫∑p üåπ",
            "Ch√∫c Linh s·ª± nghi·ªáp thƒÉng ti·∫øn v√π v√π üöÄ",
            "ƒêi ƒë√¢u c≈©ng g·∫∑p may m·∫Øn nha Linh ∆°i üçÄ",
            "Ch√∫c Linh ƒÉn m√£i kh√¥ng b√©o, lu√¥n xinh t∆∞∆°i üçï",
            "NƒÉm m·ªõi, th√†nh c√¥ng m·ªõi r·ª±c r·ª° nh√© Linh! üèÜ",
            "M√£i l√† b√¥ng hoa xinh ƒë·∫πp nh·∫•t nh√© üå∫",
            "Ch√∫c Linh t√¨m ƒë∆∞·ª£c h·∫°nh ph√∫c tr·ªçn v·∫πn üíñ",
            "Linh ∆°i, m·∫°nh m·∫Ω v√† ki√™n c∆∞·ªùng l√™n nh√© üí™",
            "NƒÉm nay h·ª©a h·∫πn nhi·ªÅu ƒëi·ªÅu tuy·ªát v·ªùi v·ªõi Linh ‚ú®",
            "Ch√∫c Linh lu√¥n ƒë∆∞·ª£c y√™u th∆∞∆°ng v√† che ch·ªü ‚òÇÔ∏è",
            "S·ª©c kh·ªèe d·ªìi d√†o ƒë·ªÉ ƒëi kh·∫Øp th·∫ø gi·ªõi üåè",
            "NƒÉm m·ªõi b√¨nh an, t√¢m h·ªìn th∆∞ th√°i nh√© Linh üçÉ",
            "Ch√∫c Linh lu√¥n t·ª± tin v√† t·ªèa s√°ng üíé",
            "Mong m·ªçi ∆∞·ªõc m∆° c·ªßa Linh th√†nh hi·ªán th·ª±c üåà",
            "NƒÉm 2026 r·ª±c r·ª° s·∫Øc m√†u nh√© Linh! üé®",
            "L√∫c n√†o m·ªát m·ªèi, nh·ªõ l√† c√≥ t·ªõ ·ªü ƒë√¢y ü§ù",
            "Ch√∫c Linh xinh ƒë·∫πp b·∫•t ch·∫•p th·ªùi gian ‚è≥",
            "T√¨nh duy√™n ph∆°i ph·ªõi nh√© c√¥ n√†ng xinh ƒë·∫πp üíï",
            "Linh c∆∞·ªùi l√™n l√† th·∫ø gi·ªõi b·ª´ng s√°ng ƒë·∫•y üòÅ",
            "Ch√∫c m·ª´ng nƒÉm m·ªõi ng∆∞·ªùi b·∫°n ƒë·∫∑c bi·ªát! ü•Ç",
            "NƒÉm nay nh·∫•t ƒë·ªãnh ph·∫£i gi√†u to nh√© Linh üí∏",
            "H·∫°nh ph√∫c ng·∫≠p tr√†n, y√™u th∆∞∆°ng lai l√°ng ü•∞",
            "Ch√∫c Linh m·ªôt nƒÉm ƒë√°ng nh·ªõ nh·∫•t thanh xu√¢n üì∏",
            "Lu√¥n gi·ªØ v·ªØng ƒëam m√™ ch√°y b·ªèng nh√© üî•",
            "NƒÉm m·ªõi, kh·ªüi ƒë·∫ßu m·ªõi th·∫≠t thu·∫≠n l·ª£i üçÄ",
            "Ch√∫c Linh g·∫∑p ƒë∆∞·ª£c ng∆∞·ªùi tr√¢n tr·ªçng m√¨nh ‚ù§Ô∏è",
            "M·ªói s√°ng th·ª©c d·∫≠y ƒë·ªÅu l√† ni·ªÅm vui m·ªõi ‚òÄÔ∏è",
            "Linh x·ª©ng ƒë√°ng v·ªõi nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t üéÅ",
            "NƒÉm m·ªõi sang ch·∫£nh, th·∫ßn th√°i ng√∫t ng√†n üëë",
            "Ch√∫c Linh lu√¥n y√™u ƒë·ªùi, y√™u ng∆∞·ªùi üíó",
            "M·ªçi kh√≥ khƒÉn s·∫Ω qua, ch·ªâ c√≤n ni·ªÅm vui ·ªü l·∫°i üåà",
            "Linh l√† ƒëi·ªÅu ng·ªçt ng√†o c·ªßa nƒÉm m·ªõi üç¨",
            "Ch√∫c Linh c√¥ng vi·ªác hanh th√¥ng, thu·∫≠n l·ª£i üìà",
            "NƒÉm nay ƒëi du l·ªãch th·∫≠t nhi·ªÅu nh√© Linh ‚úàÔ∏è",
            "M√£i b√™n nhau b·∫°n nh√©! üíû",
            "Ch√∫c Linh ng·ªß ngon, m∆° ƒë·∫πp m·ªói t·ªëi üåô",
            "NƒÉm m·ªõi ch√∫c Linh lu√¥n an nhi√™n t·ª± t·∫°i üåº",
            "G·ª≠i ng√†n n·ª• h√¥n gi√≥ t·ªõi Linh üòò",
            "Y√™u th∆∞∆°ng Linh r·∫•t nhi·ªÅu! üíñ",
            "Happy New Year 2026 - NƒÉm c·ªßa Linh! üéÜ"
        ];

        const BASE_IMAGES = ["res/image/love1.png", "res/image/love2.jpg", "res/image/back.png"];
        const NL_IMAGES = [];
        for (let i = 1; i <= 50; i++) {
            NL_IMAGES.push(`res/image/NL${i}.jpg`);
        }
        const IMAGES = [...BASE_IMAGES, ...NL_IMAGES];
        const FLOATING_IMAGES = NL_IMAGES;

        const LETTER_MESSAGES = [
            "G·ª≠i Ng·ªçc Linh,\nNƒÉm m·ªõi ƒë√£ ƒë·∫øn r·ªìi, anh mu·ªën g·ª≠i ƒë·∫øn em nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t. C·∫£m ∆°n em v√¨ ƒë√£ xu·∫•t hi·ªán v√† l√†m cu·ªôc s·ªëng c·ªßa anh tr·ªü n√™n r·ª±c r·ª° h∆°n bao gi·ªù h·∫øt. üåπ",
            "NƒÉm 2026 n√†y, anh mong em s·∫Ω lu√¥n c∆∞·ªùi th·∫≠t t∆∞∆°i, ƒë·∫°t ƒë∆∞·ª£c m·ªçi ∆∞·ªõc m∆° m√† em ·∫•p ·ªß. D√π c√≥ chuy·ªán g√¨ x·∫£y ra, h√£y nh·ªõ r·∫±ng lu√¥n c√≥ anh ·ªü ph√≠a sau ·ªßng h·ªô em h·∫øt m√¨nh. üí™‚ù§Ô∏è",
            "Y√™u em r·∫•t nhi·ªÅu! Ch√∫c m·ª´ng nƒÉm m·ªõi, c√¥ g√°i tuy·ªát v·ªùi nh·∫•t c·ªßa anh. H√£y c√πng nhau t·∫°o n√™n th·∫≠t nhi·ªÅu k·ª∑ ni·ªám ƒë·∫πp n·ªØa nh√©! üíë‚ú®"
        ];

        // --- GLOBAL VARIABLES & SELECTORS ---
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const overlayCanvas = document.getElementById('camera-overlay');
        const overlayCtx = overlayCanvas.getContext('2d');
        const videoElement = document.getElementsByClassName('input_video')[0];
        const landingScreen = document.getElementById('landing-screen');
        const startBtn = document.getElementById('start-btn');
        const loadingText = document.getElementById('loading');
        const bgLayer = document.getElementById('bg-image-layer');
        const cameraBox = document.getElementById('camera-box');
        const uiLayer = document.getElementById('ui-layer');
        const countDisplay = document.getElementById('countdown-number');
        const greetingBox = document.getElementById('greeting-box');
        const guideText = document.getElementById('guide-text');
        const floatContainer = document.getElementById('floating-container');
        const finaleTimer = document.getElementById('finale-timer'); 

        const letterContainer = document.getElementById('letter-container');
        const theBook = document.getElementById('the-book');
        const letterControls = document.getElementById('letter-controls');
        const btnOpenLetter = document.getElementById('btn-open-letter');
        const btnNextMsg = document.getElementById('btn-next-msg');
        const btnCloseLetter = document.getElementById('btn-close-letter');
        const btnResetGame = document.getElementById('btn-reset-game');
        const letterText = document.getElementById('letter-text');
        const letterPageRight = document.getElementById('letter-content-page'); 

        let appState = 'LANDING'; 
        let targetNumber = 5; 
        let fireworks = [];
        let stars = [];
        let floatInterval;
        let finaleTimerInterval; 
        let floatIndex = 0;
        let finaleOngoing = false;
        let isResetting = false;
        let shuffledImages = [];
        
        let screenFlash = 0; 
        let flashColor = '255, 105, 180';
        let currentLetterPage = 0;
        let heartInterval;

        // --- INIT & RESIZE ---
        function resize() {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            overlayCanvas.width = 160; overlayCanvas.height = 120;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- CLASS HI·ªÜU ·ª®NG ---
        class Star {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width; this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2; this.alpha = Math.random(); this.blink = Math.random() * 0.02;
            }
            draw() { ctx.fillStyle = `rgba(255,255,255,${this.alpha})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); }
            update() { this.alpha += this.blink; if(this.alpha <= 0 || this.alpha >= 1) this.blink *= -1; }
        }
        for(let i=0; i<150; i++) stars.push(new Star());

        class Firework {
            constructor(startX, startY, targetY, type = 'normal') {
                this.x = startX; this.y = startY; this.targetY = targetY; this.type = type;
                if (type === 'big-opener') { this.speed = 4.5; } else { this.speed = Math.random() * 4 + 10; }
                this.particles = []; this.exploded = false;
                if(type === 'big-opener') {
                    this.hue = 340; 
                    AUDIO.whistle.currentTime = 0; AUDIO.whistle.play().catch(e => console.log(e));
                } else if (type === 'finale-round') {
                    this.hue = Math.random() * 360; 
                } else { this.hue = Math.random() * 360; }
            }
            update() {
                if(!this.exploded) {
                    this.y -= this.speed; 
                    if (this.type === 'big-opener') { this.speed *= 0.998; } else { this.speed *= 0.95; }
                    if(this.type === 'big-opener') { ctx.fillStyle = 'rgba(255,100,150,0.8)'; ctx.beginPath(); ctx.arc(this.x, this.y + 10, 3, 0, Math.PI*2); ctx.fill(); }
                    if(this.y <= this.targetY || this.speed <= 1) this.explode();
                } else {
                    this.particles.forEach((p,i) => { p.update(); if(p.alpha <= 0) this.particles.splice(i,1); });
                }
            }
            explode() {
                this.exploded = true;
                if(this.type === 'finale-round' || this.type === 'big-opener') {
                    screenFlash = 5;
                    const flashColors = [ '255, 20, 147', '255, 0, 0', '148, 0, 211', '255, 105, 180' ];
                    flashColor = flashColors[Math.floor(Math.random() * flashColors.length)];
                }
                if (this.type === 'big-opener') {
                    AUDIO.boom.currentTime = 0; AUDIO.boom.play().catch(e => console.log(e));
                    const particleCount = 600;
                    for(let i=0; i < particleCount; i++) {
                        const t = (Math.PI * 2 * i) / particleCount;
                        const dx = 16 * Math.pow(Math.sin(t), 3);
                        const dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                        const hue = 320 + Math.random() * 40; 
                        const p = new Particle(this.x, this.y, hue, 0); 
                        const scale = 0.9 + Math.random() * 0.2; 
                        p.vx = dx * scale; p.vy = (dy - 5) * scale;
                        p.gravity = 0.05; p.friction = 0.96; p.decay = 0.005; p.sparkle = true;  
                        this.particles.push(p);
                    }
                } else {
                    let count = (this.type === 'finale-round') ? 300 : 40; 
                    let spread = (this.type === 'finale-round') ? 15 : 5;
                    for(let i=0; i<count; i++) this.particles.push(new Particle(this.x, this.y, this.hue, spread));
                }
            }
            draw() {
                if(!this.exploded) { ctx.fillStyle = (this.type === 'big-opener') ? '#fff' : `hsl(${this.hue}, 100%, 60%)`; ctx.beginPath(); ctx.arc(this.x, this.y, 4, 0, Math.PI*2); ctx.fill(); }
                else { this.particles.forEach(p => p.draw()); }
            }
        }

        class Particle {
            constructor(x, y, hue, spreadSpeed) {
                this.x = x; this.y = y;
                const angle = Math.random() * Math.PI * 2; const speed = Math.random() * spreadSpeed + 1; 
                this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed;
                this.alpha = 1; this.friction = 0.96; this.gravity = 0.04;
                this.decay = Math.random() * 0.008 + 0.004; this.hue = hue; this.sparkle = Math.random() < 0.5; 
            }
            update() {
                this.vx *= this.friction; this.vy *= this.friction;
                this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.alpha -= this.decay;
            }
            draw() {
                ctx.save(); ctx.globalCompositeOperation = 'lighter';
                let currentAlpha = this.alpha; if(this.sparkle) currentAlpha *= (0.5 + Math.random() * 0.5); 
                ctx.fillStyle = `hsla(${this.hue}, 100%, 60%, ${currentAlpha})`;
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); ctx.restore();
            }
        }

        function animateCanvas() {
            if (screenFlash > 0) {
                ctx.fillStyle = `rgba(${flashColor}, ${screenFlash * 0.015})`; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                screenFlash--;
            } else {
                ctx.fillStyle = 'rgba(0,0,0,0.2)'; 
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            if(appState !== 'LANDING') stars.forEach(s => { s.update(); s.draw(); });
            if(appState === 'COUNTDOWN' && Math.random() < 0.05) {
                fireworks.push(new Firework(Math.random() * canvas.width, canvas.height, Math.random() * (canvas.height * 0.5), 'normal'));
            }
            
            if(finaleOngoing && Math.random() < 0.08) { 
                fireworks.push(new Firework(
                    Math.random() * canvas.width, 
                    canvas.height, 
                    canvas.height * 0.05 + Math.random() * (canvas.height * 0.5), 
                    'finale-round'
                ));
            }

            fireworks.forEach((fw, i) => {
                fw.update(); fw.draw(); if(fw.exploded && fw.particles.length === 0) fireworks.splice(i,1);
            });
            requestAnimationFrame(animateCanvas);
        }
        animateCanvas();

        let imagesLoaded = 0;
        let totalImages = 0;

        function preloadAllImages() {
            totalImages = IMAGES.length;
            return new Promise((resolve) => {
                if (totalImages === 0) resolve();
                IMAGES.forEach((src) => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        imagesLoaded++;
                        loadingText.innerText = `ƒêang t·∫£i t√†i nguy√™n... ${Math.floor((imagesLoaded / totalImages) * 100)}%`;
                        if (imagesLoaded === totalImages) resolve();
                    };
                    img.onerror = () => { imagesLoaded++; if (imagesLoaded === totalImages) resolve(); };
                });
            });
        }

        startBtn.addEventListener('click', async () => {
            AUDIO.bgIntro.play().catch(e => console.log("C·∫ßn t∆∞∆°ng t√°c ng∆∞·ªùi d√πng ƒë·ªÉ ph√°t nh·∫°c"));
            landingScreen.style.opacity = 0; 
            setTimeout(() => landingScreen.style.display = 'none', 500);
            
            loadingText.style.display = 'block';
            loadingText.innerText = "ƒêang kh·ªüi ƒë·ªông Camera & T·∫£i ·∫£nh...";

            await Promise.all([initCamera(), preloadAllImages()]);
            
            loadingText.style.display = 'none'; 
            cameraBox.style.display = 'block';
            appState = 'WAITING'; 
            guideText.innerText = "Gi∆° 5 ng√≥n tay ƒë·ªÉ b·∫Øt ƒë·∫ßu...";
        });

        async function initCamera() {
            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
            hands.onResults(onResults);
            const camera = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); }, width: 640, height: 480
            });
            await camera.start();
        }

        function countFingers(landmarks) {
            let count = 0;
            if (landmarks[8].y < landmarks[6].y) count++;
            if (landmarks[12].y < landmarks[10].y) count++;
            if (landmarks[16].y < landmarks[14].y) count++;
            if (landmarks[20].y < landmarks[18].y) count++;
            const isRight = landmarks[17].x > landmarks[5].x;
            if ((isRight && landmarks[4].x < landmarks[3].x) || (!isRight && landmarks[4].x > landmarks[3].x)) count++;
            return count;
        }

        function onResults(results) {
            overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
            if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                drawConnectors(overlayCtx, lm, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 2});
                drawLandmarks(overlayCtx, lm, {color: '#ff0000', lineWidth: 1});
                const fingers = countFingers(lm);
                processGameLogic(fingers);
            } else {
                if(appState === 'COUNTDOWN') {
                    if (!isResetting) resetGame();
                }
            }
        }

        function processGameLogic(fingers) {
            if (isResetting) return; 
            if (appState === 'WAITING') {
                if(fingers === 5) startCountdown();
            } 
            else if (appState === 'COUNTDOWN') {
                if(fingers === targetNumber - 1) {
                    targetNumber = fingers;
                    if(targetNumber > 0) {
                        updateCountdownDisplay(targetNumber);
                    } else {
                        startFinaleSequence();
                    }
                }
            }
        }

        function startCountdown() {
            appState = 'COUNTDOWN'; targetNumber = 5;
            bgLayer.style.opacity = 0;
            guideText.style.bottom = '10%'; guideText.innerText = "Gi·ªØ tay v√† ƒë·∫øm ng∆∞·ª£c d·∫ßn xu·ªëng...";
            greetingBox.style.display = 'block'; countDisplay.style.display = 'block';
            updateCountdownDisplay(5);
        }

        function updateCountdownDisplay(num) {
            countDisplay.innerText = num;
            countDisplay.classList.remove('pop-anim'); void countDisplay.offsetWidth; countDisplay.classList.add('pop-anim');
            playCountSound(num);
        }

        function startFinaleSequence() {
            if(appState === 'FINALE') return;
            appState = 'FINALE';
            fadeOutAudio(AUDIO.bgIntro);
            
            greetingBox.classList.add('fade-out-transition');
            countDisplay.classList.add('fade-out-transition');
            guideText.classList.add('fade-out-transition');

            setTimeout(() => {
                greetingBox.style.display = 'none';
                countDisplay.style.display = 'none';
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.innerText = "H√£y t·∫≠n h∆∞·ªüng kho·∫£nh kh·∫Øc n√†y..."; 
                setTimeout(() => guideText.style.opacity = 0, 5000);
            }, 1500);

            fireworks = []; 

            setTimeout(() => {
                fireworks.push(new Firework(canvas.width / 2, canvas.height, canvas.height * 0.35, 'big-opener'));
                setTimeout(() => {
                    AUDIO.bgFinale.play().catch(e => console.log(e));
                    
                    floatContainer.style.display = 'block';
                    floatContainer.style.opacity = '1';
                    
                    spawnFloatingItem(); 
                    if(floatInterval) clearInterval(floatInterval);
                    floatInterval = setInterval(spawnFloatingItem, 2500);
                    finaleOngoing = true; 

                    let remainingSeconds = Math.floor(FINALE_DURATION / 1000);
                    finaleTimer.style.display = 'block';
                    finaleTimer.style.opacity = 1;
                    finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: ${remainingSeconds}s`;

                    if(finaleTimerInterval) clearInterval(finaleTimerInterval);
                    finaleTimerInterval = setInterval(() => {
                        remainingSeconds--;
                        if(remainingSeconds > 0) {
                            finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: ${remainingSeconds}s`;
                        } else {
                            finaleTimer.innerText = `T·∫≠n h∆∞·ªüng nh√© b·∫°n y√™u: 0s`;
                            clearInterval(finaleTimerInterval);
                        }
                    }, 1000);

                    setTimeout(endFinaleAndStartLetter, FINALE_DURATION);

                }, 4000); 
            }, 2000); 
        }

        function endFinaleAndStartLetter() {
            finaleOngoing = false; 
            if(floatInterval) clearInterval(floatInterval); 
            if(finaleTimerInterval) clearInterval(finaleTimerInterval); 
            
            finaleTimer.style.opacity = 0;
            setTimeout(() => finaleTimer.style.display = 'none', 1000);

            fadeOutAudio(AUDIO.bgFinale, 3000);
            
            floatContainer.style.opacity = '0';
            setTimeout(() => {
                floatContainer.innerHTML = ''; 
                floatContainer.style.display = 'none';
            }, 3000);

            setTimeout(() => {
                showLetterSequence();
            }, 5000); 
        }

        function showLetterSequence() {
            appState = 'LETTER';
            letterContainer.style.display = 'flex'; 
            letterControls.style.opacity = 1;
            
            theBook.classList.remove('open');
            currentLetterPage = 0;
            
            btnOpenLetter.style.display = 'block';
            btnOpenLetter.innerText = "M·ªü Thi·ªáp üíå"; 
            btnResetGame.style.display = 'none';
        }

        function spawnHeart() {
            const heart = document.createElement('div');
            heart.classList.add('heart-particle');
            heart.innerHTML = Math.random() < 0.5 ? '‚ù§Ô∏è' : 'üíó';
            heart.style.left = (Math.random() * 90) + '%';
            heart.style.setProperty('--rotation', (Math.random() * 60 - 30) + 'deg');
            letterPageRight.appendChild(heart);
            setTimeout(() => { if (heart.parentNode) heart.remove(); }, 3500);
        }

        btnOpenLetter.addEventListener('click', () => {
            btnOpenLetter.style.display = 'none'; 
            theBook.classList.add('open'); 
            
            if(AUDIO.bgLetter.paused) {
                AUDIO.bgLetter.play().catch(e=>console.log(e));
            }
            
            currentLetterPage = 0;
            letterText.innerText = LETTER_MESSAGES[0];
            btnNextMsg.style.display = 'inline-block';
            btnCloseLetter.style.display = 'none';

            if (heartInterval) clearInterval(heartInterval);
            spawnHeart(); 
            heartInterval = setInterval(spawnHeart, 800); 
        });

        btnNextMsg.addEventListener('click', () => {
            currentLetterPage++;
            letterText.style.opacity = 0;
            setTimeout(() => {
                if (currentLetterPage < LETTER_MESSAGES.length) {
                    letterText.innerText = LETTER_MESSAGES[currentLetterPage];
                    letterText.style.opacity = 1;
                }
                if (currentLetterPage >= 2) { 
                    btnNextMsg.style.display = 'none';
                    btnCloseLetter.style.display = 'inline-block';
                }
            }, 300);
        });

        btnCloseLetter.addEventListener('click', () => {
            theBook.classList.remove('open'); 
            if (heartInterval) clearInterval(heartInterval);
            const existingHearts = document.querySelectorAll('.heart-particle');
            existingHearts.forEach(h => h.remove());

            setTimeout(() => {
                btnOpenLetter.style.display = 'block';
                btnOpenLetter.innerText = "M·ªü l·∫°i üíå";
                btnResetGame.style.display = 'block'; 
            }, 1000); 
        });

        btnResetGame.addEventListener('click', () => {
            fadeOutAudio(AUDIO.bgLetter, 1000);
            resetGame();
        });

        function resetGame() {
            if (isResetting) return;
            isResetting = true; 
            
            if (heartInterval) clearInterval(heartInterval);
            const existingHearts = document.querySelectorAll('.heart-particle');
            existingHearts.forEach(h => h.remove());

            letterContainer.style.display = 'none';
            letterControls.style.opacity = 0;
            floatContainer.style.opacity = '0';
            
            finaleTimer.style.opacity = 0;
            finaleTimer.style.display = 'none';
            if(finaleTimerInterval) clearInterval(finaleTimerInterval);

            if(!AUDIO.bgFinale.paused) fadeOutAudio(AUDIO.bgFinale, 500);

            setTimeout(() => {
                appState = 'WAITING';
                targetNumber = 5;
                finaleOngoing = false;
                
                if(floatInterval) clearInterval(floatInterval);
                floatContainer.innerHTML = '';
                floatContainer.style.display = 'none';
                fireworks = [];
                
                bgLayer.style.opacity = 1;
                
                greetingBox.classList.remove('fade-out-transition');
                countDisplay.classList.remove('fade-out-transition');
                guideText.classList.remove('fade-out-transition');
                guideText.style.opacity = 1; 
                
                greetingBox.style.display = 'none'; 
                countDisplay.style.display = 'none';
                guideText.innerText = "Gi∆° 5 ng√≥n tay ƒë·ªÉ b·∫Øt ƒë·∫ßu...";
                guideText.style.bottom = '15%';

                AUDIO.bgIntro.currentTime = 0;
                AUDIO.bgIntro.volume = 0.4; 
                AUDIO.bgIntro.play().catch(e => console.log("User interaction needed"));

                isResetting = false; 
            }, 1000);
        }

        function spawnFloatingItem() {
            if(appState !== 'FINALE') return;
            if (shuffledImages.length === 0) {
                let indices = Array.from({length: FLOATING_IMAGES.length}, (_, i) => i);
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }
                shuffledImages = indices;
            }
            const uniqueIndex = shuffledImages.pop();

            const layoutType = Math.random() > 0.5 ? 0 : 1; 
            const msgEl = document.createElement('div'); msgEl.classList.add('float-item', 'msg-box');
            msgEl.innerText = MESSAGES[floatIndex % MESSAGES.length];
            const imgEl = document.createElement('div'); imgEl.classList.add('float-item', 'img-box');
            const img = document.createElement('img');
            img.src = FLOATING_IMAGES[uniqueIndex]; 
            imgEl.appendChild(img);
            
            // X·ª¨ L√ù V·ªä TR√ç TH√îNG MINH (MOBILE vs DESKTOP)
            const isPortrait = window.innerHeight > window.innerWidth;
            const isMobile = window.innerWidth < 768;
            
            // N·∫øu l√† ƒëi·ªán tho·∫°i d·ªçc th√¨ d√£n bi√™n ƒë·ªô ra
            let leftMin = 5, leftMax = 35, rightMin = 55, rightMax = 35;

            if (isMobile && isPortrait) {
                leftMin = 2; leftMax = 40;
                rightMin = 52; rightMax = 46;
            }

            const randomLeft = leftMin + Math.random() * leftMax; 
            const randomRight = rightMin + Math.random() * rightMax;
            
            if (layoutType === 0) { 
                msgEl.style.left = randomLeft + '%'; 
                imgEl.style.left = randomRight + '%'; 
            } else { 
                msgEl.style.left = randomRight + '%'; 
                imgEl.style.left = randomLeft + '%'; 
            }
            
            floatContainer.appendChild(msgEl); floatContainer.appendChild(imgEl);
            floatIndex++;
            setTimeout(() => { if(msgEl.parentNode) msgEl.remove(); }, 15000);
            setTimeout(() => { if(imgEl.parentNode) imgEl.remove(); }, 15000);
        }
    </script>
</body>
</html>